<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员控制台 - 物业管理系统</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/dashboard.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- 顶部导航栏 -->
        <header class="dashboard-header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="#" class="brand-logo">
                    <i class="fas fa-building"></i>
                    <span>物业管理系统</span>
                </a>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        A
                    </div>
                    <div class="user-details">
                        <h4 id="userName">管理员</h4>
                        <p id="userRole">系统管理员</p>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    退出登录
                </button>
            </div>
        </header>

        <!-- 侧边栏 -->
        <nav class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-content">

                <!-- 个人中心 -->
                <div class="sidebar-section">
                    <div class="sidebar-title">个人中心</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" data-module="profile">
                                <i class="nav-icon fas fa-user-circle"></i>
                                <span>个人信息</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- 用户管理 -->
                <div class="sidebar-section">
                    <div class="sidebar-title">用户管理</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="admin-users">
                                <i class="nav-icon fas fa-crown"></i>
                                <span>管理员管理</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="staff-users">
                                <i class="nav-icon fas fa-user-tie"></i>
                                <span>工作人员管理</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="owner-users">
                                <i class="nav-icon fas fa-users"></i>
                                <span>业主管理</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- 主内容区域 -->
        <main class="dashboard-main">
            <div class="main-content">
                <!-- 面包屑导航 -->
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item">首页</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active" id="currentPage">控制台</span>
                </div>

                <!-- 页面内容区域 -->
                <div id="pageContent">


                    <!-- 其他模块内容将在这里动态加载 -->
                    <div id="dynamic-content" style="display: none;">
                        <!-- 动态内容区域 -->
                    </div>
                </div>
            </div>
        </main>

        <!-- 移动端侧边栏覆盖层 -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
    </div>

    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script>
        // 全局变量
        let currentUser = null;
        let currentModule = 'profile';
        
        // 安全获取用户数据
        function getCurrentUserSafely() {
            try {
                const userData = localStorage.getItem('currentUser');
                if (!userData) return null;
                
                const user = JSON.parse(userData);
                if (!user || typeof user !== 'object' || !user.userType) {
                    localStorage.removeItem('currentUser');
                    return null;
                }
                return user;
            } catch (e) {
                localStorage.removeItem('currentUser');
                return null;
            }
        }



        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            loadUserInfo();
            bindEventListeners();
        });

        // 初始化页面
        function initializePage() {
            // 使用安全方法获取用户数据
            currentUser = getCurrentUserSafely();
            
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
            
            if (currentUser.userType !== 'ADMIN') {
                alert('权限不足，无法访问管理员页面');
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
                return;
            }
            
            // 自动加载profile模块
            setTimeout(() => {
                loadModule('profile');
            }, 100);
        }

        // 加载用户信息
        function loadUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name || currentUser.username;
                document.getElementById('userRole').textContent = '系统管理员';
                
                // 设置头像
                const avatar = document.getElementById('userAvatar');
                avatar.textContent = (currentUser.name || currentUser.username).charAt(0).toUpperCase();
            }
        }

        // 绑定事件监听器
        function bindEventListeners() {
            // 侧边栏切换
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);

            // 导航链接点击事件
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const module = this.dataset.module;
                    if (module) {
                        loadModule(module);
                        setActiveNavItem(this);
                    }
                });
            });

            // 响应式处理
            window.addEventListener('resize', handleResize);
        }

        // 切换侧边栏显示/隐藏
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        // 关闭侧边栏
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        // 响应式处理
        function handleResize() {
            if (window.innerWidth > 768) {
                closeSidebar();
            }
        }

        // 设置活动导航项
        function setActiveNavItem(activeLink) {
            // 移除所有活动状态
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // 添加活动状态到当前项
            activeLink.classList.add('active');
            
            // 更新面包屑
            updateBreadcrumb(activeLink.textContent.trim());
        }

        // 更新面包屑导航
        function updateBreadcrumb(pageName) {
            document.getElementById('currentPage').textContent = pageName;
        }

        // 加载模块内容
        function loadModule(module) {
            currentModule = module;
            
            const dynamicContent = document.getElementById('dynamic-content');
            
            // 显示加载状态
            dynamicContent.style.display = 'block';
            dynamicContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span class="ms-2">加载中...</span>
                </div>
            `;
            
            // 模拟加载延迟
            setTimeout(() => {
                loadModuleContent(module);
            }, 500);
        }

        // 加载具体模块内容
        function loadModuleContent(module) {
            const dynamicContent = document.getElementById('dynamic-content');
            let content = '';
            
            switch (module) {
                case 'admin-users':
                    content = getAdminUsersContent();
                    break;
                case 'staff-users':
                    content = getStaffUsersContent();
                    break;
                case 'owner-users':
                    content = getOwnerUsersContent();
                    break;
                case 'profile':
                    content = getProfileContent();
                    break;
                default:
                    content = getEmptyStateContent();
            }
            
            dynamicContent.innerHTML = content;
        }

        // 各模块内容模板
        function getAdminUsersContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-crown me-3"></i>
                        管理员管理
                    </h1>
                    <p class="page-subtitle">管理系统管理员账户</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">管理员列表</h2>
                        <button class="btn btn-primary" onclick="goToAddAdmin()">
                            <i class="fas fa-plus"></i>
                            添加管理员
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>用户名</th>
                                        <th>真实姓名</th>
                                        <th>手机号</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="adminUsersTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                <span class="ms-2">加载管理员信息中...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getStaffUsersContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-user-tie me-3"></i>
                        工作人员管理
                    </h1>
                    <p class="page-subtitle">管理物业工作人员账户</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">工作人员列表</h2>
                        <button class="btn btn-primary" onclick="goToAddStaff()">
                            <i class="fas fa-plus"></i>
                            添加工作人员
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>用户名</th>
                                        <th>真实姓名</th>
                                        <th>手机号</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="staffUsersTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                <span class="ms-2">加载工作人员信息中...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getOwnerUsersContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-users me-3"></i>
                        业主管理
                    </h1>
                    <p class="page-subtitle">管理小区业主账户信息</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">业主列表</h2>
                        <button class="btn btn-primary" onclick="goToAddOwner()">
                            <i class="fas fa-plus"></i>
                            添加业主
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>用户名</th>
                                        <th>真实姓名</th>
                                        <th>手机号</th>
                                        <th>账户余额</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="ownerUsersTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                <span class="ms-2">加载业主信息中...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }



        function getProfileContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-user-circle me-3"></i>
                        个人信息管理
                    </h1>
                    <p class="page-subtitle">管理您的个人资料和管理员设置</p>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h2 class="card-title">基本信息</h2>
                                <button class="btn btn-primary" onclick="enableEditAdminProfile()">
                                    <i class="fas fa-edit"></i>
                                    编辑信息
                                </button>
                            </div>
                            <div class="card-body">
                                <form id="adminProfileForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="adminProfileUsername" class="form-label">用户名</label>
                                            <input type="text" class="form-control" id="adminProfileUsername" readonly>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="adminProfileName" class="form-label">真实姓名</label>
                                            <input type="text" class="form-control" id="adminProfileName" readonly>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="adminProfilePhone" class="form-label">手机号码</label>
                                            <input type="tel" class="form-control" id="adminProfilePhone" readonly>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="adminProfileUserType" class="form-label">用户类型</label>
                                            <input type="text" class="form-control" id="adminProfileUserType" value="系统管理员" readonly>
                                        </div>
                                    </div>
                                    <div id="adminPasswordSection" style="display: none;">
                                        <div class="mb-3">
                                            <label for="adminProfilePassword" class="form-label">新密码</label>
                                            <input type="password" class="form-control" id="adminProfilePassword" placeholder="如不修改密码请留空">
                                            <div class="form-text">建议使用8位以上包含字母和数字的密码</div>
                                        </div>
                                        <div class="mb-3" id="adminConfirmPasswordSection" style="display: none;">
                                            <label for="adminConfirmPassword" class="form-label">确认新密码</label>
                                            <input type="password" class="form-control" id="adminConfirmPassword" placeholder="请再次输入新密码">
                                            <div class="form-text">请再次输入相同的密码</div>
                                        </div>
                                    </div>
                                    <div class="d-none" id="adminEditButtons">
                                        <button type="button" class="btn btn-success me-2" onclick="saveAdminProfile()">
                                            <i class="fas fa-save"></i>
                                            保存修改
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelEditAdminProfile()">
                                            <i class="fas fa-times"></i>
                                            取消
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getEmptyStateContent() {
            return `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="empty-state-title">页面未找到</h3>
                    <p class="empty-state-description">您访问的功能模块不存在或正在开发中</p>
                    <button class="btn btn-primary" onclick="loadModule('profile')">
                        返回个人信息
                    </button>
                </div>
            `;
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }

        // === 用户管理相关函数 ===
        
        // 管理员管理函数
        function goToAddAdmin() {
            window.location.href = 'admin-add-user.html?type=admin';
        }

        function goToAddStaff() {
            window.location.href = 'admin-add-user.html?type=staff';
        }

        function goToAddOwner() {
            window.location.href = 'admin-add-user.html?type=owner';
        }

        function editUser(userId, userType) {
            window.location.href = `admin-edit-user.html?id=${userId}&type=${userType}`;
        }

        async function deleteUser(userId, username, userType) {
            if (!confirm(`确定要删除${userType === 'ADMIN' ? '管理员' : userType === 'STAFF' ? '工作人员' : '业主'} "${username}" 吗？此操作不可撤销。`)) {
                return;
            }

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('用户删除成功！');
                    // 重新加载当前模块的数据
                    if (userType === 'ADMIN') {
                        loadAdminUsers();
                    } else if (userType === 'STAFF') {
                        loadStaffUsers();
                    } else if (userType === 'OWNER') {
                        loadOwnerUsers();
                    }
                } else {
                    const error = await response.text();
                    alert('删除失败：' + error);
                }
            } catch (error) {
                console.error('删除用户失败:', error);
                alert('删除失败，请稍后重试');
            }
        }

        // 加载管理员列表
        async function loadAdminUsers() {
            const tbody = document.getElementById('adminUsersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span class="ms-2">加载管理员信息中...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch('/api/users/type/ADMIN');
                if (response.ok) {
                    const admins = await response.json();
                    displayAdminUsers(admins);
                } else {
                    throw new Error('获取管理员信息失败');
                }
            } catch (error) {
                console.error('加载管理员列表失败:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            加载管理员信息失败，请稍后重试
                        </td>
                    </tr>
                `;
            }
        }

        function displayAdminUsers(admins) {
            const tbody = document.getElementById('adminUsersTableBody');
            if (admins.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-inbox"></i>
                            暂无管理员信息
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = admins.map(admin => `
                <tr>
                    <td>${admin.username}</td>
                    <td>${admin.name || '-'}</td>
                    <td>${admin.phone || '-'}</td>
                    <td>近期创建</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="editUser(${admin.id}, 'ADMIN')">
                            <i class="fas fa-edit"></i>
                            编辑
                        </button>
                        ${admin.id !== currentUser?.id ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${admin.id}, '${admin.username}', 'ADMIN')">
                                <i class="fas fa-trash"></i>
                                删除
                            </button>
                        ` : `
                            <span class="text-muted">当前用户</span>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        // 加载工作人员列表
        async function loadStaffUsers() {
            const tbody = document.getElementById('staffUsersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span class="ms-2">加载工作人员信息中...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch('/api/users/type/STAFF');
                if (response.ok) {
                    const staff = await response.json();
                    displayStaffUsers(staff);
                } else {
                    throw new Error('获取工作人员信息失败');
                }
            } catch (error) {
                console.error('加载工作人员列表失败:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            加载工作人员信息失败，请稍后重试
                        </td>
                    </tr>
                `;
            }
        }

        function displayStaffUsers(staff) {
            const tbody = document.getElementById('staffUsersTableBody');
            if (staff.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-inbox"></i>
                            暂无工作人员信息
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = staff.map(member => `
                <tr>
                    <td>${member.username}</td>
                    <td>${member.name || '-'}</td>
                    <td>${member.phone || '-'}</td>
                    <td>近期创建</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="editUser(${member.id}, 'STAFF')">
                            <i class="fas fa-edit"></i>
                            编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${member.id}, '${member.username}', 'STAFF')">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 加载业主列表
        async function loadOwnerUsers() {
            const tbody = document.getElementById('ownerUsersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span class="ms-2">加载业主信息中...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch('/api/users/type/OWNER');
                if (response.ok) {
                    const owners = await response.json();
                    displayOwnerUsers(owners);
                } else {
                    throw new Error('获取业主信息失败');
                }
            } catch (error) {
                console.error('加载业主列表失败:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            加载业主信息失败，请稍后重试
                        </td>
                    </tr>
                `;
            }
        }

        function displayOwnerUsers(owners) {
            const tbody = document.getElementById('ownerUsersTableBody');
            if (owners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fas fa-inbox"></i>
                            暂无业主信息
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = owners.map(owner => `
                <tr>
                    <td>${owner.username}</td>
                    <td>${owner.name || '-'}</td>
                    <td>${owner.phone || '-'}</td>
                    <td>¥${(owner.accountBalance || 0).toFixed(2)}</td>
                    <td>近期创建</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="editUser(${owner.id}, 'OWNER')">
                            <i class="fas fa-edit"></i>
                            编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${owner.id}, '${owner.username}', 'OWNER')">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // === 管理员个人信息管理相关函数 ===
        function enableEditAdminProfile() {
            // 加载当前用户信息到表单
            loadAdminProfileData();
            
            // 使表单可编辑
            document.getElementById('adminProfileUsername').readOnly = false;
            document.getElementById('adminProfileName').readOnly = false;
            document.getElementById('adminProfilePhone').readOnly = false;
            
            // 显示密码修改区域和操作按钮
            document.getElementById('adminPasswordSection').style.display = 'block';
            document.getElementById('adminEditButtons').classList.remove('d-none');
            
            // 绑定密码输入事件
            document.getElementById('adminProfilePassword').addEventListener('input', handleAdminPasswordInput);
            document.getElementById('adminConfirmPassword').addEventListener('blur', validateAdminPasswordMatch);
        }

        function cancelEditAdminProfile() {
            // 重新加载用户信息
            loadAdminProfileData();
            
            // 设置为只读
            document.getElementById('adminProfileUsername').readOnly = true;
            document.getElementById('adminProfileName').readOnly = true;
            document.getElementById('adminProfilePhone').readOnly = true;
            
            // 隐藏密码修改区域和操作按钮
            document.getElementById('adminPasswordSection').style.display = 'none';
            document.getElementById('adminConfirmPasswordSection').style.display = 'none';
            document.getElementById('adminEditButtons').classList.add('d-none');
            
            // 清空密码字段
            document.getElementById('adminProfilePassword').value = '';
            document.getElementById('adminConfirmPassword').value = '';
            
            // 清除密码验证样式
            clearAdminPasswordValidation();
        }

        function loadAdminProfileData() {
            if (currentUser) {
                document.getElementById('adminProfileUsername').value = currentUser.username || '';
                document.getElementById('adminProfileName').value = currentUser.name || '';
                document.getElementById('adminProfilePhone').value = currentUser.phone || '';
                document.getElementById('adminProfileUserType').value = '系统管理员';
            }
        }

        // 处理管理员密码输入
        function handleAdminPasswordInput() {
            const password = document.getElementById('adminProfilePassword').value;
            const confirmSection = document.getElementById('adminConfirmPasswordSection');
            
            if (password) {
                confirmSection.style.display = 'block';
            } else {
                confirmSection.style.display = 'none';
                document.getElementById('adminConfirmPassword').value = '';
                clearAdminPasswordValidation();
            }
        }

        // 验证管理员密码匹配
        function validateAdminPasswordMatch() {
            const password = document.getElementById('adminProfilePassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;
            const confirmPasswordField = document.getElementById('adminConfirmPassword');
            
            if (confirmPassword && password !== confirmPassword) {
                confirmPasswordField.classList.add('is-invalid');
                if (!confirmPasswordField.nextElementSibling || !confirmPasswordField.nextElementSibling.classList.contains('invalid-feedback')) {
                    const feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.textContent = '两次输入的密码不一致';
                    confirmPasswordField.parentNode.appendChild(feedback);
                }
            } else {
                confirmPasswordField.classList.remove('is-invalid');
                const feedback = confirmPasswordField.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.remove();
                }
            }
        }

        // 清除管理员密码验证状态
        function clearAdminPasswordValidation() {
            const confirmPasswordField = document.getElementById('adminConfirmPassword');
            confirmPasswordField.classList.remove('is-invalid');
            const feedback = confirmPasswordField.parentNode.querySelector('.invalid-feedback');
            if (feedback) {
                feedback.remove();
            }
        }

        async function saveAdminProfile() {
            const newUsername = document.getElementById('adminProfileUsername').value;
            const profileData = {
                username: newUsername,
                name: document.getElementById('adminProfileName').value,
                phone: document.getElementById('adminProfilePhone').value || null
            };

            const password = document.getElementById('adminProfilePassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;

            if (!profileData.username) {
                alert('请填写用户名');
                return;
            }

            if (!profileData.name) {
                alert('请填写真实姓名');
                return;
            }

            // 密码验证
            if (password) {
                if (password.length < 6) {
                    alert('密码长度至少6位');
                    return;
                }
                
                if (password !== confirmPassword) {
                    alert('两次输入的密码不一致');
                    return;
                }
                
                profileData.password = password;
            }

            // 检查用户名是否已存在（如果修改了用户名）
            if (newUsername !== currentUser.username) {
                try {
                    const checkResponse = await fetch(`/api/users/check-username?username=${encodeURIComponent(newUsername)}`);
                    if (checkResponse.ok) {
                        const exists = await checkResponse.json();
                        if (exists) {
                            alert('该用户名已存在，请选择其他用户名');
                            return;
                        }
                    }
                } catch (error) {
                    console.error('检查用户名失败:', error);
                }
            }

            try {
                const response = await fetch(`/api/users/${currentUser.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });

                if (response.ok) {
                    const updatedUser = await response.json();
                    
                    // 更新本地存储的用户信息
                    currentUser.username = updatedUser.username;
                    currentUser.name = updatedUser.name;
                    currentUser.phone = updatedUser.phone;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // 更新页面显示
                    loadUserInfo();
                    
                    alert('个人信息更新成功！');
                    cancelEditAdminProfile();
                } else {
                    const error = await response.text();
                    alert('更新失败：' + error);
                }
            } catch (error) {
                console.error('更新个人信息失败:', error);
                alert('更新失败，请稍后重试');
            }
        }

        // 扩展模块加载函数以自动加载数据
        const originalLoadModuleContent = loadModuleContent;
        loadModuleContent = function(module) {
            const result = originalLoadModuleContent(module);
            
            // 加载完内容后，根据模块类型加载数据
            setTimeout(() => {
                switch (module) {
                    case 'admin-users':
                        loadAdminUsers();
                        break;
                    case 'staff-users':
                        loadStaffUsers();
                        break;
                    case 'owner-users':
                        loadOwnerUsers();
                        break;
                    case 'profile':
                        loadAdminProfileData();
                        break;
                }
            }, 100);
            
            return result;
        };
    </script>
</body>
</html>
