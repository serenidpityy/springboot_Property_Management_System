<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸šä¸»ä¸­å¿ƒ - ç‰©ä¸šç®¡ç†ç³»ç»Ÿ</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/dashboard.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* å¤‡ç”¨æ¨¡æ€æ¡†æ ·å¼ */
        .modal.show {
            display: block !important;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-open {
            overflow: hidden;
        }
        
        /* ç®€å•çš„åŠ è½½åŠ¨ç”» */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="dashboard-header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="#" class="brand-logo">
                    <i class="fas fa-building"></i>
                    <span>ç‰©ä¸šç®¡ç†ç³»ç»Ÿ</span>
                </a>
            </div>
            <div class="header-right">
                <button class="btn btn-primary btn-sm me-3" onclick="goToRecharge()">
                    <i class="fas fa-plus"></i>
                    å……å€¼
                </button>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        O
                    </div>
                    <div class="user-details">
                        <h4 id="userName">ä¸šä¸»</h4>
                        <p id="userBalance">ä½™é¢: Â¥0.00</p>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    é€€å‡ºç™»å½•
                </button>
            </div>
        </header>

        <!-- ä¾§è¾¹æ  -->
        <nav class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-content">

                <!-- ä¸ªäººä¿¡æ¯ -->
                <div class="sidebar-section">
                    <div class="sidebar-title">ä¸ªäººä¿¡æ¯</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" data-module="profile">
                                <i class="nav-icon fas fa-user-circle"></i>
                                <span>ä¸ªäººä¿¡æ¯ç®¡ç†</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- æˆ‘çš„èµ„äº§ -->
                <div class="sidebar-section">
                    <div class="sidebar-title">æˆ‘çš„èµ„äº§</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="my-properties">
                                <i class="nav-icon fas fa-home"></i>
                                <span>æˆ‘çš„æˆ¿å±‹</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="my-parking">
                                <i class="nav-icon fas fa-car"></i>
                                <span>æˆ‘çš„è½¦ä½</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- è´¹ç”¨ç®¡ç† -->
                <div class="sidebar-section">
                    <div class="sidebar-title">è´¹ç”¨ç®¡ç†</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="my-charges">
                                <i class="nav-icon fas fa-credit-card"></i>
                                <span>æˆ‘çš„ç¼´è´¹ä¿¡æ¯</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- ç¤¾åŒºæœåŠ¡ -->
                <div class="sidebar-section">
                    <div class="sidebar-title">ç¤¾åŒºæœåŠ¡</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="announcements">
                                <i class="nav-icon fas fa-bullhorn"></i>
                                <span>ç¤¾åŒºå…¬å‘Š</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="complaints">
                                <i class="nav-icon fas fa-comments"></i>
                                <span>æŠ•è¯‰ä¸å»ºè®®</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="dashboard-main">
            <div class="main-content">
                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item">é¦–é¡µ</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active" id="currentPage">ä¸ªäººä¸­å¿ƒ</span>
                </div>

                <!-- é¡µé¢å†…å®¹åŒºåŸŸ -->
                <div id="pageContent">


                    <!-- å…¶ä»–æ¨¡å—å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    <div id="dynamic-content" style="display: none;">
                        <!-- åŠ¨æ€å†…å®¹åŒºåŸŸ -->
                    </div>
                </div>
            </div>
        </main>

        <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ è¦†ç›–å±‚ -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>



        <!-- å……å€¼åŠŸèƒ½å·²ç®€åŒ–ä¸ºè·³è½¬é¡µé¢ -->
    </div>
            </div>
        </div>
    </div>

    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let currentModule = 'profile';
        
        // å®‰å…¨è·å–ç”¨æˆ·æ•°æ®
        function getCurrentUserSafely() {
            try {
                const userData = localStorage.getItem('currentUser');
                if (!userData) return null;
                
                const user = JSON.parse(userData);
                if (!user || typeof user !== 'object' || !user.userType) {
                    localStorage.removeItem('currentUser');
                    return null;
                }
                return user;
            } catch (e) {
                localStorage.removeItem('currentUser');
                return null;
            }
        }



        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            loadUserInfo();
            bindEventListeners();
        });

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            // ä½¿ç”¨å®‰å…¨æ–¹æ³•è·å–ç”¨æˆ·æ•°æ®
            currentUser = getCurrentUserSafely();
            
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

                if (currentUser.userType !== 'OWNER') {
                    alert('æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®ä¸šä¸»é¡µé¢');
                localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                    return;
                }
            
            // è‡ªåŠ¨åŠ è½½profileæ¨¡å—
            setTimeout(() => {
                loadModule('profile');
            }, 100);
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        function loadUserInfo() {
            if (currentUser) {
                const nameElement = document.getElementById('userName');
                if (nameElement) {
                    nameElement.textContent = currentUser.name || currentUser.username;
                }
                
                // æ˜¾ç¤ºè´¦æˆ·ä½™é¢
                const balance = currentUser.accountBalance || 0;
                const formattedBalance = balance.toFixed(2);
                
                const userBalanceElement = document.getElementById('userBalance');
                if (userBalanceElement) {
                    userBalanceElement.textContent = `ä½™é¢: Â¥${formattedBalance}`;
                }
                

                
                const sidebarBalanceElement = document.getElementById('sidebarBalance');
                if (sidebarBalanceElement) {
                    sidebarBalanceElement.textContent = `Â¥${formattedBalance}`;
                }
                
                // è®¾ç½®å¤´åƒ
                const avatar = document.getElementById('userAvatar');
                if (avatar) {
                    avatar.textContent = (currentUser.name || currentUser.username).charAt(0).toUpperCase();
                }
                
                console.log('User info loaded, balance:', formattedBalance);
            }
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            // ä¾§è¾¹æ åˆ‡æ¢
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);

            // å¯¼èˆªé“¾æ¥ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const module = this.dataset.module;
                    if (module) {
                        loadModule(module);
                        setActiveNavItem(this);
                    }
                });
            });

            // å“åº”å¼å¤„ç†
            window.addEventListener('resize', handleResize);
        }

        // åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º/éšè—
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        // å…³é—­ä¾§è¾¹æ 
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        // å“åº”å¼å¤„ç†
        function handleResize() {
            if (window.innerWidth > 768) {
                closeSidebar();
            }
        }

        // è®¾ç½®æ´»åŠ¨å¯¼èˆªé¡¹
        function setActiveNavItem(activeLink) {
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // æ·»åŠ æ´»åŠ¨çŠ¶æ€åˆ°å½“å‰é¡¹
            activeLink.classList.add('active');
            
            // æ›´æ–°é¢åŒ…å±‘
            updateBreadcrumb(activeLink.textContent.trim());
        }

        // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
        function updateBreadcrumb(pageName) {
            document.getElementById('currentPage').textContent = pageName;
        }

        // æ˜¾ç¤ºå……å€¼æ¨¡æ€æ¡†
        function showRechargeModal() {
            const rechargeModal = new bootstrap.Modal(document.getElementById('rechargeModal'));
            rechargeModal.show();
        }

        // å¤„ç†å……å€¼
        function processRecharge() {
            const amount = document.getElementById('rechargeAmount').value;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            if (!amount || amount < 1) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å……å€¼é‡‘é¢');
                return;
            }
            
            // æ¨¡æ‹Ÿå……å€¼å¤„ç†
            if (confirm(`ç¡®è®¤ä½¿ç”¨${paymentMethod}å……å€¼ Â¥${amount} å…ƒå—ï¼Ÿ`)) {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯APIå¤„ç†å……å€¼
                alert('å……å€¼æˆåŠŸï¼é‡‘é¢å·²åˆ°è´¦ã€‚');
                
                // æ›´æ–°ç”¨æˆ·ä½™é¢ï¼ˆå®é™…åº”è¯¥ä»åç«¯è·å–æœ€æ–°ä½™é¢ï¼‰
                if (currentUser.accountBalance) {
                    currentUser.accountBalance += parseFloat(amount);
                } else {
                    currentUser.accountBalance = parseFloat(amount);
                }
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                loadUserInfo();
                
                // å…³é—­æ¨¡æ€æ¡†
                bootstrap.Modal.getInstance(document.getElementById('rechargeModal')).hide();
                
                // é‡ç½®è¡¨å•
                document.getElementById('rechargeForm').reset();
                document.getElementById('wechat').checked = true;
            }
        }

        // åŠ è½½æ¨¡å—å†…å®¹
        function loadModule(module) {
            currentModule = module;
            
            const dynamicContent = document.getElementById('dynamic-content');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            dynamicContent.style.display = 'block';
            dynamicContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span class="ms-2">åŠ è½½ä¸­...</span>
                </div>
            `;
            
            // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
            setTimeout(() => {
                loadModuleContent(module);
            }, 500);
        }

        // åŠ è½½å…·ä½“æ¨¡å—å†…å®¹
        function loadModuleContent(module) {
            const dynamicContent = document.getElementById('dynamic-content');
            let content = '';
            
            switch (module) {
                case 'profile':
                    content = getProfileContent();
                    break;
                case 'my-properties':
                    content = getMyPropertiesContent();
                    break;
                case 'my-parking':
                    content = getMyParkingContent();
                    break;
                case 'my-charges':
                    content = getMyChargesContent();
                    break;
                case 'announcements':
                    content = getAnnouncementsContent();
                    break;
                case 'complaints':
                    content = getComplaintsContent();
                    break;
                default:
                    content = getEmptyStateContent();
            }
            
            dynamicContent.innerHTML = content;
        }

        // å„æ¨¡å—å†…å®¹æ¨¡æ¿
        function getProfileContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-user-circle me-3"></i>
                        ä¸ªäººä¿¡æ¯ç®¡ç†
                    </h1>
                    <p class="page-subtitle">ç®¡ç†æ‚¨çš„ä¸ªäººèµ„æ–™å’Œè´¦æˆ·è®¾ç½®</p>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h2 class="card-title">åŸºæœ¬ä¿¡æ¯</h2>
                                <button class="btn btn-primary" onclick="enableEditProfile()">
                                    <i class="fas fa-edit"></i>
                                    ç¼–è¾‘ä¿¡æ¯
                                </button>
                            </div>
                            <div class="card-body">
                                <form id="profileForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="profileUsername" class="form-label">ç”¨æˆ·å</label>
                                            <input type="text" class="form-control" id="profileUsername" readonly>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="profileName" class="form-label">çœŸå®å§“å</label>
                                            <input type="text" class="form-control" id="profileName" readonly>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="profilePhone" class="form-label">æ‰‹æœºå·ç </label>
                                            <input type="tel" class="form-control" id="profilePhone" readonly>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="profileBalance" class="form-label">è´¦æˆ·ä½™é¢</label>
                                            <div class="input-group">
                                                <span class="input-group-text">Â¥</span>
                                                <input type="text" class="form-control" id="profileBalance" readonly>
                                            </div>
                                            <div class="form-text">ä½™é¢åªèƒ½é€šè¿‡å……å€¼å¢åŠ </div>
                                        </div>
                                    </div>
                                    <div id="passwordSection" style="display: none;">
                                        <div class="mb-3">
                                            <label for="profilePassword" class="form-label">æ–°å¯†ç </label>
                                            <input type="password" class="form-control" id="profilePassword" placeholder="å¦‚ä¸ä¿®æ”¹å¯†ç è¯·ç•™ç©º">
                                            <div class="form-text">å»ºè®®ä½¿ç”¨8ä½ä»¥ä¸ŠåŒ…å«å­—æ¯å’Œæ•°å­—çš„å¯†ç </div>
                                        </div>
                                        <div class="mb-3" id="confirmPasswordSection" style="display: none;">
                                            <label for="confirmPassword" class="form-label">ç¡®è®¤æ–°å¯†ç </label>
                                            <input type="password" class="form-control" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                                            <div class="form-text">è¯·å†æ¬¡è¾“å…¥ç›¸åŒçš„å¯†ç </div>
                                        </div>
                                    </div>
                                    <div class="d-none" id="editButtons">
                                        <button type="button" class="btn btn-success me-2" onclick="saveProfile()">
                                            <i class="fas fa-save"></i>
                                            ä¿å­˜ä¿®æ”¹
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelEditProfile()">
                                            <i class="fas fa-times"></i>
                                            å–æ¶ˆ
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h2 class="card-title">
                                    <i class="fas fa-wallet"></i>
                                    è´¦æˆ·å……å€¼
                                </h2>
                            </div>
                            <div class="card-body">
                                                                    <div class="text-center mb-3">
                                    <div class="stat-value" id="sidebarBalance">Â¥0.00</div>
                                    <p class="text-muted">å½“å‰ä½™é¢</p>
                                </div>
                                <button class="btn btn-primary w-100" onclick="goToRecharge()">
                                    <i class="fas fa-wallet"></i>
                                    ç«‹å³å……å€¼
                                </button>
                                <div class="mt-2">
                                    <small class="text-muted">æ”¯æŒå¾®ä¿¡ã€æ”¯ä»˜å®ã€é“¶è¡Œå¡</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getMyPropertiesContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-home me-3"></i>
                        æˆ‘çš„æˆ¿å±‹
                    </h1>
                    <p class="page-subtitle">æŸ¥çœ‹æ‚¨åä¸‹çš„æˆ¿äº§ä¿¡æ¯</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">æˆ¿äº§åˆ—è¡¨</h2>
                        <button class="btn btn-secondary" onclick="refreshOwnerPropertyList()">
                            <i class="fas fa-refresh"></i>
                            åˆ·æ–°
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="ownerPropertyList">
                            <div class="text-center">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <span class="ms-2">åŠ è½½æˆ¿äº§ä¿¡æ¯ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getMyParkingContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-car me-3"></i>
                        æˆ‘çš„è½¦ä½
                    </h1>
                    <p class="page-subtitle">æŸ¥çœ‹æ‚¨çš„åœè½¦ä½ä¿¡æ¯</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">è½¦ä½ä¿¡æ¯</h2>
                        <button class="btn btn-secondary" onclick="refreshOwnerParkingList()">
                            <i class="fas fa-refresh"></i>
                            åˆ·æ–°
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="ownerParkingList">
                            <div class="text-center">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <span class="ms-2">åŠ è½½è½¦ä½ä¿¡æ¯ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getMyChargesContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-credit-card me-3"></i>
                        æˆ‘çš„ç¼´è´¹ä¿¡æ¯
                    </h1>
                    <p class="page-subtitle">æŸ¥çœ‹å’Œç¼´çº³å„ç±»è´¹ç”¨</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">ç¼´è´¹è®°å½•</h2>
                        <div>
                            <button class="btn btn-warning me-2" onclick="filterOwnerChargesByStatus('UNPAID')">
                                <i class="fas fa-clock"></i>
                                å¾…ç¼´è´¹ (<span id="ownerUnpaidCount">0</span>)
                            </button>
                            <button class="btn btn-success me-2" onclick="filterOwnerChargesByStatus('PAID')">
                                <i class="fas fa-check"></i>
                                å·²ç¼´è´¹
                            </button>
                            <button class="btn btn-info" onclick="filterOwnerChargesByStatus('')">
                                <i class="fas fa-list"></i>
                                å…¨éƒ¨
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ä¸šä¸»å§“å</th>
                                        <th>æ”¶è´¹é¡¹ç›®</th>
                                        <th>æ”¶è´¹é‡‘é¢</th>
                                        <th>æ”¶è´¹è¯´æ˜</th>
                                        <th>ç¼´è´¹çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="ownerChargeTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                <span class="ms-2">åŠ è½½ç¼´è´¹ä¿¡æ¯ä¸­...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ç¼´è´¹ç¡®è®¤æ¨¡æ€æ¡† -->

            `;
        }

        function getAnnouncementsContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-bullhorn me-3"></i>
                        ç¤¾åŒºå…¬å‘Š
                    </h1>
                    <p class="page-subtitle">æŸ¥çœ‹æœ€æ–°çš„ç¤¾åŒºé€šçŸ¥å’Œå…¬å‘Š</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">å…¬å‘Šåˆ—è¡¨</h2>
                        <button class="btn btn-secondary" onclick="refreshOwnerAnnouncementList()">
                            <i class="fas fa-refresh"></i>
                            åˆ·æ–°
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="ownerAnnouncementList">
                            <div class="text-center">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <span class="ms-2">åŠ è½½å…¬å‘Šä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å…¬å‘Šè¯¦æƒ…æ¨¡æ€æ¡† -->
                <div class="modal fade" id="announcementDetailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="announcementDetailTitle">
                                    <i class="fas fa-bullhorn"></i>
                                    å…¬å‘Šè¯¦æƒ…
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <h4 id="announcementTitle"></h4>
                                    <small class="text-muted" id="announcementPublishTime"></small>
                                </div>
                                <div id="announcementContent" style="white-space: pre-wrap; line-height: 1.6;"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getComplaintsContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-comments me-3"></i>
                        æŠ•è¯‰ä¸å»ºè®®
                    </h1>
                    <p class="page-subtitle">æäº¤æŠ•è¯‰å»ºè®®æˆ–æŸ¥çœ‹å¤„ç†è¿›åº¦</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">æˆ‘çš„æŠ•è¯‰å»ºè®®</h2>
                        <div>
                            <button class="btn btn-primary me-2" onclick="goToAddOwnerComplaint()">
                                <i class="fas fa-plus"></i>
                                æ–°å¢æŠ•è¯‰/å»ºè®®
                            </button>
                            <button class="btn btn-secondary" onclick="refreshOwnerComplaintList()">
                                <i class="fas fa-refresh"></i>
                                åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>æäº¤äºº</th>
                                        <th>å†…å®¹æ‘˜è¦</th>
                                        <th>æäº¤æ—¶é—´</th>
                                        <th>æäº¤äººç”µè¯</th>
                                        <th>ç´§æ€¥ç¨‹åº¦</th>
                                        <th>å¤„ç†çŠ¶æ€</th>
                                        <th>å¤„ç†äºº</th>
                                        <th>å¤„ç†äººç”µè¯</th>
                                        <th>å¤„ç†äººå›åº”</th>
                                    </tr>
                                </thead>
                                <tbody id="ownerComplaintTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                <span class="ms-2">åŠ è½½æŠ•è¯‰å»ºè®®ä¸­...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <!-- æŠ•è¯‰è¯¦æƒ…æ¨¡æ€æ¡† -->
                <div class="modal fade" id="complaintDetailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-comments"></i>
                                    æŠ•è¯‰å»ºè®®è¯¦æƒ…
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">æäº¤æ—¶é—´ï¼š</label>
                                    <span id="complaintDetailTime"></span>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">å¤„ç†çŠ¶æ€ï¼š</label>
                                    <span id="complaintDetailStatus"></span>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">å†…å®¹ï¼š</label>
                                    <div id="complaintDetailContent" style="white-space: pre-wrap; line-height: 1.6; 
                                         padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary-color);"></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getEmptyStateContent() {
            return `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="empty-state-title">é¡µé¢æœªæ‰¾åˆ°</h3>
                    <p class="empty-state-description">æ‚¨è®¿é—®çš„åŠŸèƒ½æ¨¡å—ä¸å­˜åœ¨æˆ–æ­£åœ¨å¼€å‘ä¸­</p>
                    <button class="btn btn-primary" onclick="loadModule('profile')">
                        è¿”å›ä¸ªäººä¿¡æ¯
                    </button>
                </div>
            `;
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }

        // === å……å€¼åŠŸèƒ½ç›¸å…³å‡½æ•° ===
        // è·³è½¬åˆ°ç®€å•å……å€¼é¡µé¢
        function goToRecharge() {
            console.log('è·³è½¬åˆ°å……å€¼é¡µé¢');
            window.location.href = 'recharge.html';
        }

        // processRecharge å‡½æ•°å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨ç®€å•çš„é¡µé¢è·³è½¬å……å€¼

        // æ›´æ–°ä½™é¢æ˜¾ç¤ºçš„è¾…åŠ©å‡½æ•°
        function updateBalanceDisplay() {
            const balance = currentUser.accountBalance || 0;
            const formattedBalance = balance.toFixed(2);
            
            // æ›´æ–°ä¾§è¾¹æ ä½™é¢
            const sidebarBalance = document.getElementById('sidebarBalance');
            if (sidebarBalance) {
                sidebarBalance.textContent = `Â¥${formattedBalance}`;
            }
            
            // æ›´æ–°ä¸ªäººä¿¡æ¯é¡µé¢ä½™é¢
            const profileBalance = document.getElementById('profileBalance');
            if (profileBalance) {
                profileBalance.value = formattedBalance;
            }
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            loadUserInfo();
            
            console.log('Balance display updated to:', formattedBalance);
        }

        // ç®€åŒ–å……å€¼å‡½æ•°å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨ç‹¬ç«‹å……å€¼é¡µé¢



        // === ä¸ªäººä¿¡æ¯ç®¡ç†ç›¸å…³å‡½æ•° ===
        function enableEditProfile() {
            // åŠ è½½å½“å‰ç”¨æˆ·ä¿¡æ¯åˆ°è¡¨å•
            loadProfileData();
            
            // ä½¿è¡¨å•å¯ç¼–è¾‘
            document.getElementById('profileUsername').readOnly = false;
            document.getElementById('profileName').readOnly = false;
            document.getElementById('profilePhone').readOnly = false;
            
            // æ˜¾ç¤ºå¯†ç ä¿®æ”¹åŒºåŸŸå’Œæ“ä½œæŒ‰é’®
            document.getElementById('passwordSection').style.display = 'block';
            document.getElementById('editButtons').classList.remove('d-none');
            
            // ç»‘å®šå¯†ç è¾“å…¥äº‹ä»¶
            document.getElementById('profilePassword').addEventListener('input', handlePasswordInput);
            document.getElementById('confirmPassword').addEventListener('blur', validatePasswordMatch);
        }

        function cancelEditProfile() {
            // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
            loadProfileData();
            
            // è®¾ç½®ä¸ºåªè¯»
            document.getElementById('profileUsername').readOnly = true;
            document.getElementById('profileName').readOnly = true;
            document.getElementById('profilePhone').readOnly = true;
            
            // éšè—å¯†ç ä¿®æ”¹åŒºåŸŸå’Œæ“ä½œæŒ‰é’®
            document.getElementById('passwordSection').style.display = 'none';
            document.getElementById('confirmPasswordSection').style.display = 'none';
            document.getElementById('editButtons').classList.add('d-none');
            
            // æ¸…ç©ºå¯†ç å­—æ®µ
            document.getElementById('profilePassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            // æ¸…é™¤å¯†ç éªŒè¯æ ·å¼
            clearPasswordValidation();
        }

        function loadProfileData() {
            if (currentUser) {
                document.getElementById('profileUsername').value = currentUser.username || '';
                document.getElementById('profileName').value = currentUser.name || '';
                document.getElementById('profilePhone').value = currentUser.phone || '';
                document.getElementById('profileBalance').value = (currentUser.accountBalance || 0).toFixed(2);
                document.getElementById('sidebarBalance').textContent = `Â¥${(currentUser.accountBalance || 0).toFixed(2)}`;
            }
        }

        // å¤„ç†å¯†ç è¾“å…¥
        function handlePasswordInput() {
            const password = document.getElementById('profilePassword').value;
            const confirmSection = document.getElementById('confirmPasswordSection');
            
            if (password) {
                confirmSection.style.display = 'block';
            } else {
                confirmSection.style.display = 'none';
                document.getElementById('confirmPassword').value = '';
                clearPasswordValidation();
            }
        }

        // éªŒè¯å¯†ç åŒ¹é…
        function validatePasswordMatch() {
            const password = document.getElementById('profilePassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const confirmPasswordField = document.getElementById('confirmPassword');
            
            if (confirmPassword && password !== confirmPassword) {
                confirmPasswordField.classList.add('is-invalid');
                if (!confirmPasswordField.nextElementSibling || !confirmPasswordField.nextElementSibling.classList.contains('invalid-feedback')) {
                    const feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                    confirmPasswordField.parentNode.appendChild(feedback);
                }
            } else {
                confirmPasswordField.classList.remove('is-invalid');
                const feedback = confirmPasswordField.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.remove();
                }
            }
        }

        // æ¸…é™¤å¯†ç éªŒè¯çŠ¶æ€
        function clearPasswordValidation() {
            const confirmPasswordField = document.getElementById('confirmPassword');
            confirmPasswordField.classList.remove('is-invalid');
            const feedback = confirmPasswordField.parentNode.querySelector('.invalid-feedback');
            if (feedback) {
                feedback.remove();
            }
        }

        async function saveProfile() {
            const newUsername = document.getElementById('profileUsername').value;
            const profileData = {
                username: newUsername,
                name: document.getElementById('profileName').value,
                phone: document.getElementById('profilePhone').value || null
            };

            const password = document.getElementById('profilePassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!profileData.username) {
                alert('è¯·å¡«å†™ç”¨æˆ·å');
                return;
            }

            if (!profileData.name) {
                alert('è¯·å¡«å†™çœŸå®å§“å');
                return;
            }

            // å¯†ç éªŒè¯
            if (password) {
                if (password.length < 6) {
                    alert('å¯†ç é•¿åº¦è‡³å°‘6ä½');
                    return;
                }
                
                if (password !== confirmPassword) {
                    alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                    return;
                }
                
                profileData.password = password;
            }

            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨ï¼ˆå¦‚æœä¿®æ”¹äº†ç”¨æˆ·åï¼‰
            if (newUsername !== currentUser.username) {
                try {
                    const checkResponse = await fetch(`/api/users/check-username?username=${encodeURIComponent(newUsername)}`);
                    if (checkResponse.ok) {
                        const exists = await checkResponse.json();
                        if (exists) {
                            alert('è¯¥ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·å');
                            return;
                        }
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥ç”¨æˆ·åå¤±è´¥:', error);
                }
            }

            try {
                const response = await fetch(`/api/users/${currentUser.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });

                if (response.ok) {
                    const updatedUser = await response.json();
                    
                    // æ›´æ–°æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
                    currentUser.username = updatedUser.username;
                    currentUser.name = updatedUser.name;
                    currentUser.phone = updatedUser.phone;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    loadUserInfo();
                    
                    alert('ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                    cancelEditProfile();
                } else {
                    const error = await response.text();
                    alert('æ›´æ–°å¤±è´¥ï¼š' + error);
                }
            } catch (error) {
                console.error('æ›´æ–°ä¸ªäººä¿¡æ¯å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // === ç¤¾åŒºå…¬å‘ŠæŸ¥çœ‹ç›¸å…³å‡½æ•° ===
        function refreshOwnerAnnouncementList() {
            loadOwnerAnnouncementList();
        }

        async function loadOwnerAnnouncementList() {
            const container = document.getElementById('ownerAnnouncementList');
            container.innerHTML = `
                <div class="text-center">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span class="ms-2">åŠ è½½å…¬å‘Šä¸­...</span>
                    </div>
                </div>
            `;

            try {
                const response = await fetch('/api/announcements');
                if (response.ok) {
                    const announcements = await response.json();
                    displayOwnerAnnouncementList(announcements);
                } else {
                    throw new Error('è·å–å…¬å‘Šä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å…¬å‘Šåˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        åŠ è½½å…¬å‘Šä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                    </div>
                `;
            }
        }

        function displayOwnerAnnouncementList(announcements) {
            const container = document.getElementById('ownerAnnouncementList');
            if (announcements.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-inbox"></i>
                        <p>æš‚æ— å…¬å‘Šä¿¡æ¯</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = announcements.map(announcement => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5 class="card-title">${announcement.title}</h5>
                                <p class="card-text text-muted" onclick="showAnnouncementSimple('${announcement.title.replace(/'/g, "\\'")}', '${announcement.content.replace(/'/g, "\\'").replace(/\n/g, "\\n")}', '${announcement.publishTime}')" style="cursor: pointer;">
                                    ${announcement.content.length > 100 ? announcement.content.substring(0, 100) + '...' : announcement.content}
                                </p>
                                <small class="text-muted">
                                    <i class="fas fa-calendar"></i>
                                    ${new Date(announcement.publishTime).toLocaleDateString()}
                                </small>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="showAnnouncementDetail(${announcement.id}, '${announcement.title.replace(/'/g, "\\'")}', '${announcement.content.replace(/'/g, "\\'").replace(/\n/g, "\\n")}', '${announcement.publishTime}')" title="æŸ¥çœ‹å®Œæ•´å†…å®¹">
                                <i class="fas fa-eye me-1"></i>
                                æŸ¥çœ‹
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showAnnouncementSimple(title, content, publishTime) {
            // ä½¿ç”¨alertæ˜¾ç¤ºå…¬å‘Šè¯¦ç»†å†…å®¹
            const formattedTime = new Date(publishTime).toLocaleString('zh-CN');
            const message = `ğŸ“¢ å…¬å‘Šè¯¦æƒ…\n\nğŸ“‹ æ ‡é¢˜ï¼š${title}\n\nğŸ“ å†…å®¹ï¼š\n${content}\n\nğŸ“… å‘å¸ƒæ—¶é—´ï¼š${formattedTime}`;
            alert(message);
        }

        function showAnnouncementDetail(id, title, content, publishTime) {
            // ä½¿ç”¨alertæ˜¾ç¤ºå…¬å‘Šè¯¦ç»†å†…å®¹
            const formattedTime = new Date(publishTime).toLocaleString('zh-CN');
            const message = `ğŸ“¢ å…¬å‘Šè¯¦æƒ…\n\nğŸ“‹ æ ‡é¢˜ï¼š${title}\n\nğŸ“ å†…å®¹ï¼š\n${content}\n\nğŸ“… å‘å¸ƒæ—¶é—´ï¼š${formattedTime}`;
            alert(message);
        }

        // === æŠ•è¯‰ä¸å»ºè®®ç›¸å…³å‡½æ•° ===
        function showAddComplaintModal() {
            const modal = new bootstrap.Modal(document.getElementById('addComplaintModal'));
            modal.show();
        }

        async function saveOwnerComplaint() {
            const content = document.getElementById('complaintContent').value;
            if (!content.trim()) {
                alert('è¯·è¾“å…¥æŠ•è¯‰æˆ–å»ºè®®å†…å®¹');
                return;
            }

            const complaintData = {
                owner: { id: currentUser.id },
                content: content.trim(),
                processingStatus: 'PENDING',
                submissionTime: new Date().toISOString()
            };

            try {
                const response = await fetch('/api/complaints', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(complaintData)
                });

                if (response.ok) {
                    alert('æŠ•è¯‰å»ºè®®æäº¤æˆåŠŸï¼æˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ã€‚');
                    bootstrap.Modal.getInstance(document.getElementById('addComplaintModal')).hide();
                    document.getElementById('addComplaintForm').reset();
                    refreshOwnerComplaintList();
                } else {
                    const error = await response.text();
                    alert('æäº¤å¤±è´¥ï¼š' + error);
                }
            } catch (error) {
                console.error('æäº¤æŠ•è¯‰å»ºè®®å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        function refreshOwnerComplaintList() {
            loadOwnerComplaintList();
        }

        async function loadOwnerComplaintList() {
            const tbody = document.getElementById('ownerComplaintTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span class="ms-2">åŠ è½½æŠ•è¯‰å»ºè®®ä¸­...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                // è·å–å½“å‰ç”¨æˆ·çš„æŠ•è¯‰å»ºè®®
                const response = await fetch('/api/complaints');
                if (response.ok) {
                    const allComplaints = await response.json();
                    const myComplaints = allComplaints.filter(c => c.owner && c.owner.id === currentUser.id);
                    displayOwnerComplaintList(myComplaints);
                } else {
                    throw new Error('è·å–æŠ•è¯‰å»ºè®®å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æŠ•è¯‰å»ºè®®åˆ—è¡¨å¤±è´¥:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            åŠ è½½æŠ•è¯‰å»ºè®®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                        </td>
                    </tr>
                `;
            }
        }

        function displayOwnerComplaintList(complaints) {
            const tbody = document.getElementById('ownerComplaintTableBody');
            
            // å­˜å‚¨å½“å‰æŠ•è¯‰åˆ—è¡¨ä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
            currentOwnerComplaintsList = complaints;
            
            if (complaints.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            <i class="fas fa-inbox"></i>
                            æ‚¨è¿˜æ²¡æœ‰æäº¤è¿‡æŠ•è¯‰æˆ–å»ºè®®
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = complaints.map(complaint => {
                const urgencyLevelMap = {
                    'LOW': 'ä¸€èˆ¬',
                    'MEDIUM': 'ä¸­ç­‰',
                    'HIGH': 'è¾ƒé«˜',
                    'URGENT': 'ç´§æ€¥'
                };
                const urgencyColorMap = {
                    'LOW': 'secondary',
                    'MEDIUM': 'info', 
                    'HIGH': 'warning',
                    'URGENT': 'danger'
                };
                
                return `
                <tr>
                    <td>${complaint.owner ? (complaint.owner.name || complaint.owner.username) : '-'}</td>
                    <td>
                        <span onclick="showOwnerComplaintContent('${complaint.content.replace(/'/g, "\\'")}', 'å†…å®¹è¯¦æƒ…')" 
                              style="cursor: pointer; color: #007bff; text-decoration: underline;">
                            ${complaint.content.length > 30 ? complaint.content.substring(0, 30) + '...' : complaint.content}
                        </span>
                    </td>
                    <td>${new Date(complaint.submissionTime).toLocaleString('zh-CN')}</td>
                    <td>${complaint.submitterPhone || complaint.owner?.phone || '-'}</td>
                    <td>
                        <span class="badge badge-${urgencyColorMap[complaint.urgencyLevel] || 'secondary'}">
                            ${urgencyLevelMap[complaint.urgencyLevel] || 'ä¸€èˆ¬'}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-${complaint.processingStatus === 'PROCESSED' ? 'success' : 'warning'}">
                            ${complaint.processingStatus === 'PROCESSED' ? 'å·²å¤„ç†' : 'å¾…å¤„ç†'}
                        </span>
                    </td>
                    <td>${complaint.processor ? (complaint.processor.name || complaint.processor.username) : '-'}</td>
                    <td>${complaint.processor?.phone || '-'}</td>
                    <td>
                        ${complaint.processorResponse ? 
                            `<span onclick="showOwnerProcessorResponse(${complaint.id})" 
                                   style="cursor: pointer; color: #007bff; text-decoration: underline;">
                                ${complaint.processorResponse.length > 20 ? complaint.processorResponse.substring(0, 20) + '...' : complaint.processorResponse}
                             </span>` : '-'}
                    </td>
                </tr>
                `;
            }).join('');
        }

        let currentOwnerComplaintsList = []; // å­˜å‚¨å½“å‰æŠ•è¯‰åˆ—è¡¨

        function showOwnerComplaintContent(content, title) {
            alert(`${title}ï¼š\n\n${content}`);
        }

        function showOwnerProcessorResponse(complaintId) {
            const complaint = currentOwnerComplaintsList.find(c => c.id === complaintId);
            if (complaint && complaint.processorResponse) {
                alert(`å¤„ç†äººå›åº”ï¼š\n\n${complaint.processorResponse}`);
            } else {
                alert('æš‚æ— å¤„ç†äººå›åº”');
            }
        }

        function showOwnerComplaintDetail(content, submissionTime, status) {
            document.getElementById('complaintDetailContent').textContent = content;
            document.getElementById('complaintDetailTime').textContent = new Date(submissionTime).toLocaleString();
            document.getElementById('complaintDetailStatus').innerHTML = `
                <span class="badge badge-${status === 'PROCESSED' ? 'success' : 'warning'}">
                    ${status === 'PROCESSED' ? 'å·²å¤„ç†' : 'å¾…å¤„ç†'}
                </span>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('complaintDetailModal'));
            modal.show();
        }

        // === æˆ‘çš„èµ„äº§ç›¸å…³å‡½æ•° ===
        function refreshOwnerPropertyList() {
            loadOwnerPropertyList();
        }

        async function loadOwnerPropertyList() {
            const container = document.getElementById('ownerPropertyList');
            container.innerHTML = `
                <div class="text-center">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span class="ms-2">åŠ è½½æˆ¿äº§ä¿¡æ¯ä¸­...</span>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`/api/properties/owner/${currentUser.id}`);
                if (response.ok) {
                    const properties = await response.json();
                    displayOwnerPropertyList(properties);
                } else {
                    throw new Error('è·å–æˆ¿äº§ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æˆ¿äº§åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        åŠ è½½æˆ¿äº§ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                    </div>
                `;
            }
        }

        function displayOwnerPropertyList(properties) {
            const container = document.getElementById('ownerPropertyList');
            if (properties.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-home"></i>
                        <p>æ‚¨åä¸‹æš‚æ— æˆ¿äº§ä¿¡æ¯</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = properties.map(property => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="card-title">
                                    <i class="fas fa-home text-primary"></i>
                                    ${property.houseNumber}
                                </h5>
                                <p class="card-text">
                                    <strong>ä½ç½®ï¼š</strong>${property.building}æ ‹ ${property.unit}å•å…ƒ<br>
                                    <strong>é¢ç§¯ï¼š</strong>${property.area ? property.area + 'ã¡' : 'æœªè®¾ç½®'}<br>
                                    <strong>æˆ¿å‹ï¼š</strong>${property.houseType || 'æœªè®¾ç½®'}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="card-text">
                                    <strong>å…¥ä½çŠ¶æ€ï¼š</strong>
                                    <span class="badge badge-${getOccupancyBadgeClass(property.occupancyInfo)}">
                                        ${property.occupancyInfo || 'æœªè®¾ç½®'}
                                    </span>
                                </p>
                                ${property.additionalDescription ? `<p class="card-text"><strong>å¤‡æ³¨ï¼š</strong>${property.additionalDescription}</p>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function refreshOwnerParkingList() {
            loadOwnerParkingList();
        }

        async function loadOwnerParkingList() {
            const container = document.getElementById('ownerParkingList');
            container.innerHTML = `
                <div class="text-center">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span class="ms-2">åŠ è½½è½¦ä½ä¿¡æ¯ä¸­...</span>
                    </div>
                </div>
            `;

            try {
                const response = await fetch('/api/parking');
                if (response.ok) {
                    const allParkingSpaces = await response.json();
                    const myParkingSpaces = allParkingSpaces.filter(p => p.owner && p.owner.id === currentUser.id);
                    displayOwnerParkingList(myParkingSpaces);
                } else {
                    throw new Error('è·å–è½¦ä½ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½è½¦ä½åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        åŠ è½½è½¦ä½ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                    </div>
                `;
            }
        }

        function displayOwnerParkingList(parkingSpaces) {
            const container = document.getElementById('ownerParkingList');
            if (parkingSpaces.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-car"></i>
                        <p>æ‚¨åä¸‹æš‚æ— è½¦ä½ä¿¡æ¯</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = parkingSpaces.map(parking => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-car text-primary"></i>
                            è½¦ä½ç¼–å·ï¼š${parking.parkingId}
                        </h5>
                        <p class="card-text">
                            <strong>ä¸šä¸»ï¼š</strong>${parking.owner ? (parking.owner.name || parking.owner.username) : '-'}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        function getOccupancyBadgeClass(occupancy) {
            switch (occupancy) {
                case 'å·²å…¥ä½': return 'success';
                case 'æœªå…¥ä½': return 'secondary';
                case 'è£…ä¿®ä¸­': return 'warning';
                case 'å‡ºç§Ÿä¸­': return 'info';
                default: return 'secondary';
            }
        }

        // === ç¼´è´¹ä¿¡æ¯ç®¡ç†ç›¸å…³å‡½æ•° ===
        let currentOwnerChargeFilter = '';
        let currentChargeForPayment = null;

        function filterOwnerChargesByStatus(status) {
            currentOwnerChargeFilter = status;
            loadOwnerChargeList();
        }

        async function loadOwnerChargeList() {
            const tbody = document.getElementById('ownerChargeTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span class="ms-2">åŠ è½½ç¼´è´¹ä¿¡æ¯ä¸­...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch('/api/charges');
                if (response.ok) {
                    const allCharges = await response.json();
                    const myCharges = allCharges.filter(c => c.owner && c.owner.id === currentUser.id);
                    displayOwnerChargeList(myCharges);
                    updateOwnerUnpaidCount(myCharges);
                } else {
                    throw new Error('è·å–ç¼´è´¹ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ç¼´è´¹åˆ—è¡¨å¤±è´¥:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            åŠ è½½ç¼´è´¹ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                        </td>
                    </tr>
                `;
            }
        }

        function updateOwnerUnpaidCount(charges) {
            const unpaidCount = charges.filter(c => c.paymentStatus === 'UNPAID').length;
            const countElement = document.getElementById('ownerUnpaidCount');
            if (countElement) {
                countElement.textContent = unpaidCount;
            }
        }

        function displayOwnerChargeList(charges) {
            const tbody = document.getElementById('ownerChargeTableBody');
            
            // æ ¹æ®çŠ¶æ€è¿‡æ»¤
            let filteredCharges = charges;
            if (currentOwnerChargeFilter) {
                filteredCharges = charges.filter(c => c.paymentStatus === currentOwnerChargeFilter);
            }

            if (filteredCharges.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fas fa-inbox"></i>
                            æš‚æ— ç¼´è´¹è®°å½•
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredCharges.map(charge => `
                <tr>
                    <td>${charge.owner ? (charge.owner.name || charge.owner.username) : '-'}</td>
                    <td>${charge.chargeItem}</td>
                    <td class="fw-bold text-danger">Â¥${charge.amount.toFixed(2)}</td>
                    <td>${charge.description || '-'}</td>
                    <td>
                        <span class="badge badge-${charge.paymentStatus === 'PAID' ? 'success' : 'warning'}">
                            ${charge.paymentStatus === 'PAID' ? 'å·²ç¼´è´¹' : 'æœªç¼´è´¹'}
                        </span>
                    </td>
                    <td>
                        ${charge.paymentStatus === 'UNPAID' ? 
                            `<button class="btn btn-sm btn-primary" onclick="goToPayCharge(${charge.id})">
                                <i class="fas fa-credit-card"></i>
                                ç¼´è´¹
                            </button>` : 
                            `<span class="text-success">
                                <i class="fas fa-check"></i>
                                å·²ç¼´è´¹
                            </span>`}
                    </td>
                </tr>
            `).join('');
        }

        function showPayChargeModal(chargeId, chargeItem, amount, description) {
            currentChargeForPayment = chargeId;
            
            document.getElementById('payChargeItem').textContent = chargeItem;
            document.getElementById('payChargeAmount').textContent = 'Â¥' + amount.toFixed(2);
            document.getElementById('payAccountBalance').textContent = 'Â¥' + (currentUser.accountBalance || 0).toFixed(2);
            
            if (description) {
                document.getElementById('payChargeDescriptionText').textContent = description;
                document.getElementById('payChargeDescription').style.display = 'block';
            } else {
                document.getElementById('payChargeDescription').style.display = 'none';
            }

            const balance = currentUser.accountBalance || 0;
            const sufficientBalance = balance >= amount;
            
            if (sufficientBalance) {
                document.getElementById('insufficientBalanceAlert').style.display = 'none';
                document.getElementById('confirmPayBtn').style.display = 'inline-block';
                document.getElementById('rechargeBtn').style.display = 'none';
            } else {
                document.getElementById('insufficientBalanceAlert').style.display = 'block';
                document.getElementById('confirmPayBtn').style.display = 'none';
                document.getElementById('rechargeBtn').style.display = 'inline-block';
            }

            const modal = new bootstrap.Modal(document.getElementById('payChargeModal'));
            modal.show();
        }

        async function confirmPayCharge() {
            if (!currentChargeForPayment) {
                alert('ç¼´è´¹ä¿¡æ¯é”™è¯¯');
                return;
            }

            try {
                // å…ˆè·å–å½“å‰è´¹ç”¨ä¿¡æ¯
                const chargeResponse = await fetch(`/api/charges/${currentChargeForPayment}`);
                if (!chargeResponse.ok) {
                    throw new Error('è·å–è´¹ç”¨ä¿¡æ¯å¤±è´¥');
                }
                const charge = await chargeResponse.json();

                // æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
                if (currentUser.accountBalance < charge.amount) {
                    alert('è´¦æˆ·ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼');
                    return;
                }

                // æ›´æ–°è´¹ç”¨çŠ¶æ€ä¸ºå·²ç¼´è´¹
                const updateResponse = await fetch(`/api/charges/${currentChargeForPayment}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paymentStatus: 'PAID',
                        paymentTime: new Date().toISOString()
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error('æ›´æ–°ç¼´è´¹çŠ¶æ€å¤±è´¥');
                }

                // æ›´æ–°ç”¨æˆ·ä½™é¢
                const newBalance = currentUser.accountBalance - charge.amount;
                const balanceResponse = await fetch(`/api/users/${currentUser.id}/balance`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: newBalance })
                });

                if (balanceResponse.ok) {
                    // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
                    currentUser.accountBalance = newBalance;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    loadUserInfo();
                    
                    alert('ç¼´è´¹æˆåŠŸï¼ä½™é¢å·²æ›´æ–°ã€‚');
                    bootstrap.Modal.getInstance(document.getElementById('payChargeModal')).hide();
                    loadOwnerChargeList();
                } else {
                    alert('ç¼´è´¹æˆåŠŸï¼Œä½†ä½™é¢æ›´æ–°å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æœ€æ–°ä½™é¢');
                }
            } catch (error) {
                console.error('ç¼´è´¹å¤±è´¥:', error);
                alert('ç¼´è´¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // === ç¼´è´¹é¡µé¢è·³è½¬å‡½æ•° ===
        function goToPayCharge(chargeId) {
            window.location.href = `owner-pay-charge.html?id=${chargeId}`;
        }

        // === æŠ•è¯‰å»ºè®®é¡µé¢è·³è½¬å‡½æ•° ===
        function goToAddOwnerComplaint() {
            window.location.href = 'owner-add-complaint.html';
        }

        // æ‰©å±•æ¨¡å—åŠ è½½å‡½æ•°
        const originalLoadModuleContent = loadModuleContent;
        loadModuleContent = function(module) {
            const result = originalLoadModuleContent(module);
            
            // åŠ è½½å®Œå†…å®¹åï¼Œæ ¹æ®æ¨¡å—ç±»å‹åŠ è½½æ•°æ®
            setTimeout(() => {
                switch (module) {
                    case 'profile':
                        loadProfileData();
                        break;
                    case 'announcements':
                        loadOwnerAnnouncementList();
                        break;
                    case 'complaints':
                        loadOwnerComplaintList();
                        break;
                    case 'my-properties':
                        loadOwnerPropertyList();
                        break;
                    case 'my-parking':
                        loadOwnerParkingList();
                        break;
                    case 'my-charges':
                        loadOwnerChargeList();
                        break;
                }
            }, 100);
            
            return result;
        };

        // å…¨å±€æµ‹è¯•å‡½æ•° - å¯ä»¥ä»æµè§ˆå™¨æ§åˆ¶å°è°ƒç”¨
        window.testRecharge = async function(amount = 100) {
            if (!currentUser) {
                console.log('è¯·å…ˆç™»å½•ä¸šä¸»è´¦æˆ·');
                return;
            }
            
            console.log(`æµ‹è¯•å……å€¼: Â¥${amount}`);
            
            try {
                const oldBalance = currentUser.accountBalance || 0;
                const newBalance = oldBalance + amount;
                
                console.log(`å½“å‰ä½™é¢: Â¥${oldBalance.toFixed(2)}`);
                console.log(`å……å€¼é‡‘é¢: Â¥${amount.toFixed(2)}`);
                console.log(`é¢„æœŸæ–°ä½™é¢: Â¥${newBalance.toFixed(2)}`);
                
                const response = await fetch(`/api/users/${currentUser.id}/balance`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: newBalance })
                });
                
                console.log(`APIå“åº”çŠ¶æ€: ${response.status}`);
                
                if (response.ok) {
                    const updatedUser = await response.json();
                    console.log('âœ… å……å€¼æˆåŠŸ!', updatedUser);
                    
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    currentUser.accountBalance = updatedUser.accountBalance;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // æ›´æ–°æ˜¾ç¤º
                    updateBalanceDisplay();
                    
                    alert(`å……å€¼æˆåŠŸï¼æ–°ä½™é¢ï¼šÂ¥${updatedUser.accountBalance.toFixed(2)}`);
                    return updatedUser;
                } else {
                    const error = await response.text();
                    console.error('âŒ å……å€¼å¤±è´¥:', error);
                    alert('å……å€¼å¤±è´¥ï¼š' + error);
                }
            } catch (error) {
                console.error('âŒ ç½‘ç»œé”™è¯¯:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
            }
        };

        // å…¨å±€å‡½æ•° - æ‰“å¼€å……å€¼æ¨¡æ€æ¡†
        window.openRechargeModal = function() {
            showRechargeModal();
        };

        // å…¨å±€å‡½æ•° - æ£€æŸ¥å½“å‰ç”¨æˆ·
        window.checkCurrentUser = function() {
            console.log('å½“å‰ç”¨æˆ·:', currentUser);
            return currentUser;
        };
    </script>
</body>
</html>
