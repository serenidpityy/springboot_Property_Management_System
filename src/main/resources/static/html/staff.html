<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作人员控制台 - 物业管理系统</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/dashboard.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

</head>
<body>
    <div class="dashboard-container">
        <!-- 顶部导航栏 -->
        <header class="dashboard-header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="#" class="brand-logo">
                    <i class="fas fa-building"></i>
                    <span>物业管理系统</span>
                </a>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        S
                    </div>
                    <div class="user-details">
                        <h4 id="userName">工作人员</h4>
                        <p id="userRole">物业管理员</p>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    退出登录
                </button>
            </div>
        </header>

        <!-- 侧边栏 -->
        <nav class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-content">


                <div class="sidebar-section">
                    <div class="sidebar-title">个人信息</div>
                    <ul class="nav-menu">

                        <li class="nav-item">
                            <a href="#" class="nav-link active" data-module="profile">
                                <i class="nav-icon fas fa-user-circle"></i>
                                <span>个人信息管理</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- 业主管理 -->
                <div class="sidebar-section">
                    <div class="sidebar-title">业主管理</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="owner-info">
                                <i class="nav-icon fas fa-users"></i>
                                <span>业主信息管理</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- 房产管理 -->
                <div class="sidebar-section">
                    <div class="sidebar-title">房产管理</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="property-management">
                                <i class="nav-icon fas fa-home"></i>
                                <span>住房信息管理</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="parking-management">
                                <i class="nav-icon fas fa-car"></i>
                                <span>小区车位管理</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- 收费管理 -->
                <div class="sidebar-section">
                    <div class="sidebar-title">收费管理</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="charge-management">
                                <i class="nav-icon fas fa-credit-card"></i>
                                <span>收费管理</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- 社区服务 -->
                <div class="sidebar-section">
                    <div class="sidebar-title">社区服务</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="announcements">
                                <i class="nav-icon fas fa-bullhorn"></i>
                                <span>社区公告管理</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-module="complaints">
                                <i class="nav-icon fas fa-comments"></i>
                                <span>业主投诉与建议</span>
                            </a>
                        </li>
                    </ul>
                </div>


            </div>
        </nav>

        <!-- 主内容区域 -->
        <main class="dashboard-main">
            <div class="main-content">
                <!-- 面包屑导航 -->
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item">首页</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active" id="currentPage">工作台</span>
                </div>

                <!-- 页面内容区域 -->
                <div id="pageContent">


                    <!-- 其他模块内容将在这里动态加载 -->
                    <div id="dynamic-content" style="display: none;">
                        <!-- 动态内容区域 -->
                    </div>
                </div>
            </div>
        </main>

        <!-- 移动端侧边栏覆盖层 -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
    </div>

    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/staff-functions.js"></script>
    <script>
        // 全局变量
        let currentUser = null;
        let currentModule = 'profile';
        
        // 安全获取用户数据
        function getCurrentUserSafely() {
            try {
                const userData = localStorage.getItem('currentUser');
                if (!userData) return null;
                
                const user = JSON.parse(userData);
                if (!user || typeof user !== 'object' || !user.userType) {
                    localStorage.removeItem('currentUser');
                    return null;
                }
                return user;
            } catch (e) {
                localStorage.removeItem('currentUser');
                return null;
            }
        }



        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            loadUserInfo();
            bindEventListeners();
        });

        // 初始化页面
        function initializePage() {
            // 使用安全方法获取用户数据
            currentUser = getCurrentUserSafely();
            
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

                if (currentUser.userType !== 'STAFF') {
                    alert('权限不足，无法访问工作人员页面');
                localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                    return;
                }
            
            // 自动加载profile模块
            setTimeout(() => {
                loadModule('profile');
            }, 100);
        }

        // 加载用户信息
        function loadUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name || currentUser.username;
                document.getElementById('userRole').textContent = '物业管理员';
                
                // 设置头像
                const avatar = document.getElementById('userAvatar');
                avatar.textContent = (currentUser.name || currentUser.username).charAt(0).toUpperCase();
            }
        }

        // 绑定事件监听器
        function bindEventListeners() {
            // 侧边栏切换
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);

            // 导航链接点击事件
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const module = this.dataset.module;
                    if (module) {
                        loadModule(module);
                        setActiveNavItem(this);
                    }
                });
            });

            // 响应式处理
            window.addEventListener('resize', handleResize);
        }

        // 切换侧边栏显示/隐藏
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        // 关闭侧边栏
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        // 响应式处理
        function handleResize() {
            if (window.innerWidth > 768) {
                closeSidebar();
            }
        }

        // 设置活动导航项
        function setActiveNavItem(activeLink) {
            // 移除所有活动状态
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // 添加活动状态到当前项
            activeLink.classList.add('active');
            
            // 更新面包屑
            updateBreadcrumb(activeLink.textContent.trim());
        }

        // 更新面包屑导航
        function updateBreadcrumb(pageName) {
            document.getElementById('currentPage').textContent = pageName;
        }

        // 加载模块内容
        function loadModule(module) {
            currentModule = module;
            
            const dynamicContent = document.getElementById('dynamic-content');
            
            // 显示加载状态
            dynamicContent.style.display = 'block';
            dynamicContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span class="ms-2">加载中...</span>
                </div>
            `;
            
            // 模拟加载延迟
            setTimeout(() => {
                loadModuleContent(module);
            }, 500);
        }

        // 加载具体模块内容
        function loadModuleContent(module) {
            const dynamicContent = document.getElementById('dynamic-content');
            let content = '';
            
            switch (module) {
                case 'owner-info':
                    content = getOwnerInfoContent();
                    break;
                case 'property-management':
                    content = getPropertyManagementContent();
                    break;
                case 'parking-management':
                    content = getParkingManagementContent();
                    break;
                case 'charge-management':
                    content = getChargeManagementContent();
                    break;
                case 'announcements':
                    content = getAnnouncementsContent();
                    break;
                case 'complaints':
                    content = getComplaintsContent();
                    break;
                case 'profile':
                    content = getProfileContent();
                    break;
                default:
                    content = getEmptyStateContent();
            }
            
            dynamicContent.innerHTML = content;
        }

        // 各模块内容模板
        function getOwnerInfoContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-users me-3"></i>
                        业主信息管理
                    </h1>
                    <p class="page-subtitle">查看和管理业主基本信息</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">业主列表</h2>
                        <div>
                            <button class="btn btn-success" onclick="refreshOwnerList()">
                                <i class="fas fa-refresh"></i>
                                刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>用户名</th>
                                        <th>业主姓名</th>
                                        <th>手机号</th>
                                        <th>账户余额</th>
                                        <th>注册时间</th>
                                    </tr>
                                </thead>
                                <tbody id="ownerTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                <span class="ms-2">加载业主信息中...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getPropertyManagementContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-home me-3"></i>
                        住房信息管理
                    </h1>
                    <p class="page-subtitle">管理小区房产信息，包括房屋基本信息和入住状态</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">房产列表</h2>
                        <div>
                            <button class="btn btn-primary me-2" onclick="goToAddProperty()">
                                <i class="fas fa-plus"></i>
                                添加房产
                            </button>
                            <button class="btn btn-success" onclick="refreshPropertyList()">
                                <i class="fas fa-refresh"></i>
                                刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>房屋号</th>
                                        <th>业主</th>
                                        <th>楼栋</th>
                                        <th>单元</th>
                                        <th>面积(㎡)</th>
                                        <th>房型</th>
                                        <th>入住信息</th>
                                        <th>入住时间</th>
                                        <th>业主手机号</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="propertyTableBody">
                                    <tr>
                                        <td colspan="10" class="text-center">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                <span class="ms-2">加载房产信息中...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>




            `;
        }

        function getParkingManagementContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-car me-3"></i>
                        小区车位管理
                    </h1>
                    <p class="page-subtitle">管理小区停车位信息和分配情况</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">车位列表</h2>
                        <div>
                            <button class="btn btn-primary me-2" onclick="goToAddParking()">
                                <i class="fas fa-plus"></i>
                                添加车位
                            </button>
                            <button class="btn btn-success" onclick="refreshParkingList()">
                                <i class="fas fa-refresh"></i>
                                刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>车位编号</th>
                                        <th>业主姓名</th>
                                        <th>业主手机号</th>
                                        <th>分配时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="parkingTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                <span class="ms-2">加载车位信息中...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getChargeManagementContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-credit-card me-3"></i>
                        收费管理
                    </h1>
                    <p class="page-subtitle">管理各类收费项目和缴费记录</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">收费记录</h2>
                        <div>
                            <button class="btn btn-primary me-2" onclick="goToAddCharge()">
                                <i class="fas fa-plus"></i>
                                新增收费记录
                            </button>
                            <button class="btn btn-info" onclick="refreshChargeList()">
                                <i class="fas fa-refresh"></i>
                                刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>收费项目</th>
                                        <th>业主姓名</th>
                                        <th>收费金额</th>
                                        <th>收费说明</th>
                                        <th>缴费状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="chargeTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                <span class="ms-2">加载收费信息中...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getAnnouncementsContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-bullhorn me-3"></i>
                        社区公告管理
                    </h1>
                    <p class="page-subtitle">发布和管理社区公告通知</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">公告列表</h2>
                        <div>
                            <button class="btn btn-primary me-2" onclick="goToAddAnnouncement()">
                                <i class="fas fa-plus"></i>
                                新增公告
                            </button>
                            <button class="btn btn-success" onclick="refreshAnnouncementList()">
                                <i class="fas fa-refresh"></i>
                                刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>标题</th>
                                        <th>内容摘要</th>
                                        <th>发布时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="announcementTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                <span class="ms-2">加载公告信息中...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



            `;
        }

        function getComplaintsContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-comments me-3"></i>
                        业主投诉与建议管理
                    </h1>
                    <p class="page-subtitle">处理业主投诉和建议，提供及时反馈</p>
                </div>
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">投诉建议列表</h2>
                        <div>
                            <button class="btn btn-warning me-2" onclick="filterComplaintsByStatus('PENDING')">
                                <i class="fas fa-clock"></i>
                                待处理 (<span id="pendingCount">0</span>)
                            </button>
                            <button class="btn btn-success me-2" onclick="filterComplaintsByStatus('PROCESSED')">
                                <i class="fas fa-check"></i>
                                已处理
                            </button>
                            <button class="btn btn-info" onclick="filterComplaintsByStatus('')">
                                <i class="fas fa-list"></i>
                                全部
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>提交人</th>
                                        <th>内容摘要</th>
                                        <th>提交时间</th>
                                        <th>提交人电话</th>
                                        <th>紧急程度</th>
                                        <th>处理状态</th>
                                        <th>处理人</th>
                                        <th>处理人电话</th>
                                        <th>处理人回应</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="complaintTableBody">
                                    <tr>
                                        <td colspan="10" class="text-center">
                                            <div class="loading">
                                                <div class="spinner"></div>
                                                <span class="ms-2">加载投诉建议中...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getProfileContent() {
            return `
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-user-circle me-3"></i>
                        个人信息管理
                    </h1>
                    <p class="page-subtitle">管理您的个人资料和工作设置</p>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h2 class="card-title">基本信息</h2>
                                <button class="btn btn-primary" onclick="enableEditStaffProfile()">
                                    <i class="fas fa-edit"></i>
                                    编辑信息
                                </button>
                            </div>
                            <div class="card-body">
                                <form id="staffProfileForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="staffProfileUsername" class="form-label">用户名</label>
                                            <input type="text" class="form-control" id="staffProfileUsername" readonly>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="staffProfileName" class="form-label">真实姓名</label>
                                            <input type="text" class="form-control" id="staffProfileName" readonly>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="staffProfilePhone" class="form-label">手机号码</label>
                                            <input type="tel" class="form-control" id="staffProfilePhone" readonly>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="staffProfileUserType" class="form-label">用户类型</label>
                                            <input type="text" class="form-control" id="staffProfileUserType" value="工作人员" readonly>
                                        </div>
                                    </div>
                                    <div id="staffPasswordSection" style="display: none;">
                                        <div class="mb-3">
                                            <label for="staffProfilePassword" class="form-label">新密码</label>
                                            <input type="password" class="form-control" id="staffProfilePassword" placeholder="如不修改密码请留空">
                                            <div class="form-text">建议使用8位以上包含字母和数字的密码</div>
                                        </div>
                                        <div class="mb-3" id="staffConfirmPasswordSection" style="display: none;">
                                            <label for="staffConfirmPassword" class="form-label">确认新密码</label>
                                            <input type="password" class="form-control" id="staffConfirmPassword" placeholder="请再次输入新密码">
                                            <div class="form-text">请再次输入相同的密码</div>
                                        </div>
                                    </div>
                                    <div class="d-none" id="staffEditButtons">
                                        <button type="button" class="btn btn-success me-2" onclick="saveStaffProfile()">
                                            <i class="fas fa-save"></i>
                                            保存修改
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelEditStaffProfile()">
                                            <i class="fas fa-times"></i>
                                            取消
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getEmptyStateContent() {
            return `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="empty-state-title">页面未找到</h3>
                    <p class="empty-state-description">您访问的功能模块不存在或正在开发中</p>
                    <button class="btn btn-primary" onclick="loadModule('profile')">
                        返回个人信息
                    </button>
                </div>
            `;
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }

        // === 业主信息管理相关函数 ===
        function refreshOwnerList() {
            loadOwnerList();
        }

        async function loadOwnerList(searchParams = {}) {
            const tbody = document.getElementById('ownerTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span class="ms-2">加载业主信息中...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch('/api/users/type/OWNER');
                if (response.ok) {
                    const owners = await response.json();
                    displayOwnerList(owners);
                } else {
                    throw new Error('获取业主信息失败');
                }
            } catch (error) {
                console.error('加载业主列表失败:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            加载业主信息失败，请稍后重试
                        </td>
                    </tr>
                `;
            }
        }

        function displayOwnerList(owners) {
            const tbody = document.getElementById('ownerTableBody');
            if (owners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fas fa-inbox"></i>
                            暂无业主信息
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = owners.map(owner => {
                // 使用数据库中的真实注册时间
                let registrationTime;
                if (owner.registrationTime) {
                    registrationTime = new Date(owner.registrationTime);
                } else {
                    // 如果没有注册时间，使用默认时间
                    registrationTime = new Date('2023-01-01T00:00:00');
                }
                const formattedTime = registrationTime.getFullYear() + '/' + 
                                    (registrationTime.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                    registrationTime.getDate().toString().padStart(2, '0') + ' ' + 
                                    registrationTime.getHours().toString().padStart(2, '0') + ':' + 
                                    registrationTime.getMinutes().toString().padStart(2, '0') + ':' + 
                                    registrationTime.getSeconds().toString().padStart(2, '0');
                
                return `
                <tr>
                    <td>${owner.username}</td>
                    <td>${owner.name || '-'}</td>
                    <td>${owner.phone || '-'}</td>
                    <td>¥${(owner.accountBalance || 0).toFixed(2)}</td>
                        <td>${formattedTime}</td>
                </tr>
                `;
            }).join('');
        }



        // === 房产管理相关函数 ===
        function goToAddProperty() {
            window.location.href = 'staff-add-property.html';
        }

        // 编辑房产信息
        function editProperty(propertyId) {
            window.location.href = `staff-edit-property.html?id=${propertyId}`;
        }



        // 删除房产信息
        async function deleteProperty(propertyId, houseNumber) {
            if (!confirm(`确定要删除房产 "${houseNumber}" 吗？此操作不可撤销。`)) {
                return;
            }

            try {
                const response = await fetch(`/api/properties/${propertyId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('房产信息删除成功！');
                    refreshPropertyList();
                } else {
                    const error = await response.text();
                    alert('删除失败：' + error);
                }
            } catch (error) {
                console.error('删除房产失败:', error);
                alert('删除失败，请稍后重试');
            }
        }



        function refreshPropertyList() {
            loadPropertyList();
        }



        async function loadPropertyList() {
            const tbody = document.getElementById('propertyTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span class="ms-2">加载房产信息中...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch('/api/properties');
                if (response.ok) {
                    const properties = await response.json();
                    displayPropertyList(properties);
                } else {
                    throw new Error('获取房产信息失败');
                }
            } catch (error) {
                console.error('加载房产列表失败:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            加载房产信息失败，请稍后重试
                        </td>
                    </tr>
                `;
            }
        }

        function displayPropertyList(properties) {
            const tbody = document.getElementById('propertyTableBody');
            if (properties.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted">
                            <i class="fas fa-inbox"></i>
                            暂无房产信息
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = properties.map(property => {
                const isOccupied = property.occupancyInfo === '已入住';
                let moveInTime = '-';
                let ownerPhone = '-';
                
                if (isOccupied) {
                    // 使用数据库中的真实入住时间
                    if (property.moveInTime) {
                        const moveInDate = new Date(property.moveInTime);
                        moveInTime = moveInDate.getFullYear() + '/' + 
                                   (moveInDate.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                   moveInDate.getDate().toString().padStart(2, '0') + ' ' + 
                                   moveInDate.getHours().toString().padStart(2, '0') + ':' + 
                                   moveInDate.getMinutes().toString().padStart(2, '0') + ':' + 
                                   moveInDate.getSeconds().toString().padStart(2, '0');
                    } else {
                        moveInTime = '-';
                    }
                    
                    ownerPhone = property.owner?.phone || '-';
                }
                
                return `
                <tr>
                    <td>${property.houseNumber}</td>
                    <td>${property.owner ? (property.owner.name || property.owner.username) : '-'}</td>
                    <td>${property.building}</td>
                    <td>${property.unit}</td>
                    <td>${property.area ? property.area + '㎡' : '-'}</td>
                    <td>${property.houseType || '-'}</td>
                    <td>
                        <span class="badge badge-${getOccupancyBadgeClass(property.occupancyInfo)}">
                            ${property.occupancyInfo || '未设置'}
                        </span>
                    </td>
                        <td>${moveInTime}</td>
                        <td>${ownerPhone}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="editProperty(${property.id})">
                            <i class="fas fa-edit"></i>
                            编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProperty(${property.id}, '${property.houseNumber}')">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function getOccupancyBadgeClass(occupancy) {
            switch (occupancy) {
                case '已入住': return 'success';
                case '未入住': return 'secondary';
                case '装修中': return 'warning';
                case '出租中': return 'info';
                default: return 'secondary';
            }
        }





        // === 车位管理相关函数 ===
        function goToAddParking() {
            window.location.href = 'staff-add-parking.html';
        }

        function editParking(parkingId) {
            window.location.href = `staff-edit-parking.html?id=${parkingId}`;
        }

        async function deleteParking(parkingId, parkingIdDisplay) {
            if (!confirm(`确定要删除车位 "${parkingIdDisplay}" 吗？此操作不可撤销。`)) {
                return;
            }

            try {
                const response = await fetch(`/api/parking/${parkingId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('车位删除成功！');
                    refreshParkingList();
                } else {
                    alert('删除失败，请稍后重试');
                }
            } catch (error) {
                console.error('删除车位失败:', error);
                alert('删除失败，请稍后重试');
            }
        }

        function refreshParkingList() {
            loadParkingList();
        }

        async function loadParkingList() {
            const tbody = document.getElementById('parkingTableBody');
            
            if (!tbody) {
                console.error('车位表格元素未找到');
                return;
            }
            
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span class="ms-2">加载车位信息中...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch('/api/parking');
                if (response.ok) {
                    const parkingSpaces = await response.json();
                    displayParkingList(parkingSpaces);
                } else {
                    throw new Error(`获取车位信息失败: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('加载车位列表失败:', error);
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                加载车位信息失败，请稍后重试
                                <br>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadParkingList()">
                                    <i class="fas fa-redo"></i>
                                    重新加载
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        function displayParkingList(parkingSpaces) {
            const tbody = document.getElementById('parkingTableBody');
            if (parkingSpaces.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-inbox"></i>
                            暂无车位信息
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = parkingSpaces.map(parking => {
                // 使用数据库中的真实分配时间
                let allocationTime;
                if (parking.allocationTime) {
                    allocationTime = new Date(parking.allocationTime);
                } else {
                    // 如果没有分配时间，使用默认时间
                    allocationTime = new Date('2023-09-01T00:00:00');
                }
                
                const formattedTime = allocationTime.getFullYear() + '/' + 
                                    (allocationTime.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                    allocationTime.getDate().toString().padStart(2, '0') + ' ' + 
                                    allocationTime.getHours().toString().padStart(2, '0') + ':' + 
                                    allocationTime.getMinutes().toString().padStart(2, '0') + ':' + 
                                    allocationTime.getSeconds().toString().padStart(2, '0');
                
                return `
                <tr>
                    <td>${parking.parkingId}</td>
                    <td>${parking.owner ? (parking.owner.name || parking.owner.username) : '-'}</td>
                    <td>${parking.owner ? (parking.owner.phone || '-') : '-'}</td>
                        <td>${formattedTime}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="editParking(${parking.id})">
                            <i class="fas fa-edit"></i>
                            编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteParking(${parking.id}, '${parking.parkingId}')">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // 在模块加载时自动加载数据
        const originalLoadModuleContent = loadModuleContent;
        loadModuleContent = function(module) {
            const content = originalLoadModuleContent(module);
            
            // 加载完内容后，根据模块类型加载数据
            setTimeout(() => {
                switch (module) {
                    case 'owner-info':
                        loadOwnerList();
                        break;
                    case 'property-management':
                        loadPropertyList();
                        break;
                    case 'parking-management':
                        loadParkingList();
                        break;
                    case 'announcements':
                        loadAnnouncementList();
                        break;
                }
            }, 100);
            
            return content;
        };

        // === 公告管理相关函数 ===
        function goToAddAnnouncement() {
            window.location.href = 'staff-add-announcement.html';
        }

        function refreshAnnouncementList() {
            loadAnnouncementList();
        }

        async function loadAnnouncementList() {
            const tbody = document.getElementById('announcementTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span class="ms-2">加载公告信息中...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch('/api/announcements');
                if (response.ok) {
                    const announcements = await response.json();
                    displayAnnouncementList(announcements);
                } else {
                    throw new Error('获取公告信息失败');
                }
            } catch (error) {
                console.error('加载公告列表失败:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            加载公告信息失败，请稍后重试
                        </td>
                    </tr>
                `;
            }
        }

        function displayAnnouncementList(announcements) {
            
            const tbody = document.getElementById('announcementTableBody');
            if (announcements.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            <i class="fas fa-inbox"></i>
                            暂无公告信息
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = announcements.map((announcement, index) => `
                <tr>
                    <td>${announcement.title}</td>
                    <td>
                        <span onclick="showAnnouncementDetails('${announcement.title.replace(/'/g, "\\'")}', '${announcement.content.replace(/'/g, "\\'").replace(/\n/g, "\\n")}', '${announcement.publishTime}')" 
                              style="cursor: pointer; color: #007bff; text-decoration: underline;">
                            ${announcement.content.length > 50 ? announcement.content.substring(0, 50) + '...' : announcement.content}
                        </span>
                    </td>
                    <td>${new Date(announcement.publishTime).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="editAnnouncement(${announcement.id})">
                            <i class="fas fa-edit"></i>
                            编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAnnouncement(${announcement.id}, '${announcement.title}')">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function showAnnouncementDetails(title, content, publishTime) {
            // 简单的窗口显示完整内容
            const formattedTime = new Date(publishTime).toLocaleString('zh-CN');
            const message = `标题：${title}\n\n内容：\n${content}\n\n发布时间：${formattedTime}`;
            alert(message);
        }

        function editAnnouncement(announcementId) {
            window.location.href = `staff-edit-announcement.html?id=${announcementId}`;
        }

        async function deleteAnnouncement(announcementId, title) {
            if (!confirm(`确定要删除公告 "${title}" 吗？此操作不可撤销。`)) {
                return;
            }

            try {
                const response = await fetch(`/api/announcements/${announcementId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('公告删除成功！');
                    refreshAnnouncementList();
                } else {
                    alert('删除失败，请稍后重试');
                }
            } catch (error) {
                console.error('删除公告失败:', error);
                alert('删除失败，请稍后重试');
            }
        }

        // === 投诉建议管理相关函数 ===
        function filterComplaintsByStatus(status) {
            currentComplaintFilter = status;
            loadComplaintList();
        }

        let currentComplaintFilter = '';

        async function loadComplaintList() {
            const tbody = document.getElementById('complaintTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span class="ms-2">加载投诉建议中...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch('/api/complaints');
                if (response.ok) {
                    const complaints = await response.json();
                    displayComplaintList(complaints);
                    updatePendingCount(complaints);
                } else {
                    throw new Error('获取投诉建议失败');
                }
            } catch (error) {
                console.error('加载投诉建议列表失败:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            加载投诉建议失败，请稍后重试
                        </td>
                    </tr>
                `;
            }
        }

        function updatePendingCount(complaints) {
            const pendingCount = complaints.filter(c => c.processingStatus === 'PENDING').length;
            const countElement = document.getElementById('pendingCount');
            if (countElement) {
                countElement.textContent = pendingCount;
            }
        }

        function displayComplaintList(complaints) {
            const tbody = document.getElementById('complaintTableBody');
            
            // 存储当前投诉列表供其他函数使用
            currentComplaintsList = complaints;
            
            // 根据状态过滤
            let filteredComplaints = complaints;
            if (currentComplaintFilter) {
                filteredComplaints = complaints.filter(c => c.processingStatus === currentComplaintFilter);
            }

            if (filteredComplaints.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted">
                            <i class="fas fa-inbox"></i>
                            暂无投诉建议信息
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredComplaints.map(complaint => {
                const urgencyLevelMap = {
                    'LOW': '一般',
                    'MEDIUM': '中等',
                    'HIGH': '较高',
                    'URGENT': '紧急'
                };
                const urgencyColorMap = {
                    'LOW': 'secondary',
                    'MEDIUM': 'info', 
                    'HIGH': 'warning',
                    'URGENT': 'danger'
                };
                
                return `
                <tr>
                    <td>${complaint.owner ? (complaint.owner.name || complaint.owner.username) : '-'}</td>
                    <td>
                        <span onclick="showComplaintContent('${complaint.content.replace(/'/g, "\\'")}', '内容详情')" 
                              style="cursor: pointer; color: #007bff; text-decoration: underline;">
                            ${complaint.content.length > 30 ? complaint.content.substring(0, 30) + '...' : complaint.content}
                        </span>
                    </td>
                    <td>${new Date(complaint.submissionTime).toLocaleString('zh-CN')}</td>
                    <td>${complaint.submitterPhone || complaint.owner?.phone || '-'}</td>
                    <td>
                        <span class="badge badge-${urgencyColorMap[complaint.urgencyLevel] || 'secondary'}">
                            ${urgencyLevelMap[complaint.urgencyLevel] || '一般'}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-${complaint.processingStatus === 'PROCESSED' ? 'success' : 'warning'}">
                            ${complaint.processingStatus === 'PROCESSED' ? '已处理' : '待处理'}
                        </span>
                    </td>
                    <td>${complaint.processor ? (complaint.processor.name || complaint.processor.username) : '-'}</td>
                    <td>${complaint.processor?.phone || '-'}</td>
                    <td>
                        ${complaint.processorResponse ? 
                            `<span onclick="showProcessorResponse(${complaint.id})" 
                                   style="cursor: pointer; color: #007bff; text-decoration: underline;">
                                ${complaint.processorResponse.length > 20 ? complaint.processorResponse.substring(0, 20) + '...' : complaint.processorResponse}
                             </span>` : '-'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="editComplaint(${complaint.id})">
                            <i class="fas fa-edit"></i>
                            编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteComplaint(${complaint.id})">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        async function markComplaintAsProcessed(complaintId) {
            if (!confirm('确定要将此投诉标记为已处理吗？')) {
                return;
            }

            try {
                // 获取当前工作人员信息
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) {
                    alert('请先登录');
                    return;
                }

                const response = await fetch(`/api/complaints/${complaintId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        processingStatus: 'PROCESSED',
                        processor: { id: currentUser.id },
                        processingTime: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    alert('投诉已标记为已处理！');
                    loadComplaintList();
                } else {
                    alert('操作失败，请稍后重试');
                }
            } catch (error) {
                console.error('标记投诉状态失败:', error);
                alert('操作失败，请稍后重试');
            }
        }

        async function deleteComplaint(complaintId) {
            if (!confirm('确定要删除此投诉建议吗？此操作不可撤销。')) {
                return;
            }

            try {
                const response = await fetch(`/api/complaints/${complaintId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('投诉建议删除成功！');
                    loadComplaintList();
                } else {
                    alert('删除失败，请稍后重试');
                }
            } catch (error) {
                console.error('删除投诉建议失败:', error);
                alert('删除失败，请稍后重试');
            }
        }

        // === 投诉建议管理相关函数 ===
        let currentComplaintsList = []; // 存储当前投诉列表

        function showComplaintContent(content, title) {
            alert(`${title}：\n\n${content}`);
        }

        function showProcessorResponse(complaintId) {
            const complaint = currentComplaintsList.find(c => c.id === complaintId);
            if (complaint && complaint.processorResponse) {
                alert(`处理人回应：\n\n${complaint.processorResponse}`);
            } else {
                alert('暂无处理人回应');
            }
        }

        function editComplaint(complaintId) {
            window.location.href = `staff-edit-complaint.html?id=${complaintId}`;
        }

        // === 收费管理相关函数 ===
        function goToAddCharge() {
            window.location.href = 'staff-add-charge.html';
        }

        function refreshChargeList() {
            loadChargeList();
        }



        async function loadChargeList() {
            const tbody = document.getElementById('chargeTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span class="ms-2">加载收费信息中...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch('/api/charges');
                if (response.ok) {
                    const charges = await response.json();
                    displayChargeList(charges);
                } else {
                    throw new Error('获取收费信息失败');
                }
            } catch (error) {
                console.error('加载收费列表失败:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            加载收费信息失败，请稍后重试
                        </td>
                    </tr>
                `;
            }
        }

        function displayChargeList(charges) {
            const tbody = document.getElementById('chargeTableBody');
            if (charges.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <i class="fas fa-inbox"></i>
                            暂无收费记录
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = charges.map(charge => {
                return `
                <tr>
                    <td>${charge.chargeItem}</td>
                    <td>${charge.owner ? (charge.owner.name || charge.owner.username) : '-'}</td>
                    <td>¥${charge.amount.toFixed(2)}</td>
                    <td>${charge.description || '-'}</td>
                    <td>
                        <span class="badge badge-${charge.paymentStatus === 'PAID' ? 'success' : 'warning'}">
                            ${charge.paymentStatus === 'PAID' ? '已缴费' : '未缴费'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="editCharge(${charge.id})">
                            <i class="fas fa-edit"></i>
                            编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCharge(${charge.id})">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function editCharge(chargeId) {
            window.location.href = `staff-edit-charge.html?id=${chargeId}`;
        }

        async function deleteCharge(chargeId) {
            if (!confirm('确定要删除这条收费记录吗？此操作不可撤销。')) {
                return;
            }

            try {
                const response = await fetch(`/api/charges/${chargeId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('收费记录删除成功！');
                    refreshChargeList();
                } else {
                    alert('删除失败，请稍后重试');
                }
            } catch (error) {
                console.error('删除收费记录失败:', error);
                alert('删除失败，请稍后重试');
            }
        }

        // === 工作人员个人信息管理相关函数 ===
        function enableEditStaffProfile() {
            // 加载当前用户信息到表单
            loadStaffProfileData();
            
            // 使表单可编辑
            document.getElementById('staffProfileUsername').readOnly = false;
            document.getElementById('staffProfileName').readOnly = false;
            document.getElementById('staffProfilePhone').readOnly = false;
            
            // 显示密码修改区域和操作按钮
            document.getElementById('staffPasswordSection').style.display = 'block';
            document.getElementById('staffEditButtons').classList.remove('d-none');
            
            // 绑定密码输入事件
            document.getElementById('staffProfilePassword').addEventListener('input', handleStaffPasswordInput);
            document.getElementById('staffConfirmPassword').addEventListener('blur', validateStaffPasswordMatch);
        }

        function cancelEditStaffProfile() {
            // 重新加载用户信息
            loadStaffProfileData();
            
            // 设置为只读
            document.getElementById('staffProfileUsername').readOnly = true;
            document.getElementById('staffProfileName').readOnly = true;
            document.getElementById('staffProfilePhone').readOnly = true;
            
            // 隐藏密码修改区域和操作按钮
            document.getElementById('staffPasswordSection').style.display = 'none';
            document.getElementById('staffConfirmPasswordSection').style.display = 'none';
            document.getElementById('staffEditButtons').classList.add('d-none');
            
            // 清空密码字段
            document.getElementById('staffProfilePassword').value = '';
            document.getElementById('staffConfirmPassword').value = '';
            
            // 清除密码验证样式
            clearStaffPasswordValidation();
        }

        function loadStaffProfileData() {
            if (currentUser) {
                document.getElementById('staffProfileUsername').value = currentUser.username || '';
                document.getElementById('staffProfileName').value = currentUser.name || '';
                document.getElementById('staffProfilePhone').value = currentUser.phone || '';
                document.getElementById('staffProfileUserType').value = '工作人员';
            }
        }

        // 处理工作人员密码输入
        function handleStaffPasswordInput() {
            const password = document.getElementById('staffProfilePassword').value;
            const confirmSection = document.getElementById('staffConfirmPasswordSection');
            
            if (password) {
                confirmSection.style.display = 'block';
            } else {
                confirmSection.style.display = 'none';
                document.getElementById('staffConfirmPassword').value = '';
                clearStaffPasswordValidation();
            }
        }

        // 验证工作人员密码匹配
        function validateStaffPasswordMatch() {
            const password = document.getElementById('staffProfilePassword').value;
            const confirmPassword = document.getElementById('staffConfirmPassword').value;
            const confirmPasswordField = document.getElementById('staffConfirmPassword');
            
            if (confirmPassword && password !== confirmPassword) {
                confirmPasswordField.classList.add('is-invalid');
                if (!confirmPasswordField.nextElementSibling || !confirmPasswordField.nextElementSibling.classList.contains('invalid-feedback')) {
                    const feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.textContent = '两次输入的密码不一致';
                    confirmPasswordField.parentNode.appendChild(feedback);
                }
            } else {
                confirmPasswordField.classList.remove('is-invalid');
                const feedback = confirmPasswordField.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.remove();
                }
            }
        }

        // 清除工作人员密码验证状态
        function clearStaffPasswordValidation() {
            const confirmPasswordField = document.getElementById('staffConfirmPassword');
            confirmPasswordField.classList.remove('is-invalid');
            const feedback = confirmPasswordField.parentNode.querySelector('.invalid-feedback');
            if (feedback) {
                feedback.remove();
            }
        }

        async function saveStaffProfile() {
            const newUsername = document.getElementById('staffProfileUsername').value;
            const profileData = {
                username: newUsername,
                name: document.getElementById('staffProfileName').value,
                phone: document.getElementById('staffProfilePhone').value || null
            };

            const password = document.getElementById('staffProfilePassword').value;
            const confirmPassword = document.getElementById('staffConfirmPassword').value;

            if (!profileData.username) {
                alert('请填写用户名');
                return;
            }

            if (!profileData.name) {
                alert('请填写真实姓名');
                return;
            }

            // 密码验证
            if (password) {
                if (password.length < 6) {
                    alert('密码长度至少6位');
                    return;
                }
                
                if (password !== confirmPassword) {
                    alert('两次输入的密码不一致');
                    return;
                }
                
                profileData.password = password;
            }

            // 检查用户名是否已存在（如果修改了用户名）
            if (newUsername !== currentUser.username) {
                try {
                    const checkResponse = await fetch(`/api/users/check-username?username=${encodeURIComponent(newUsername)}`);
                    if (checkResponse.ok) {
                        const exists = await checkResponse.json();
                        if (exists) {
                            alert('该用户名已存在，请选择其他用户名');
                            return;
                        }
                    }
                } catch (error) {
                    console.error('检查用户名失败:', error);
                }
            }

            try {
                const response = await fetch(`/api/users/${currentUser.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });

                if (response.ok) {
                    const updatedUser = await response.json();
                    
                    // 更新本地存储的用户信息
                    currentUser.username = updatedUser.username;
                    currentUser.name = updatedUser.name;
                    currentUser.phone = updatedUser.phone;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // 更新页面显示
                    loadUserInfo();
                    
                    alert('个人信息更新成功！');
                    cancelEditStaffProfile();
                } else {
                    const error = await response.text();
                    alert('更新失败：' + error);
                }
            } catch (error) {
                console.error('更新个人信息失败:', error);
                alert('更新失败，请稍后重试');
            }
        }

        // 扩展模块加载函数以包含新功能
        const originalLoadModuleContentUpdate = loadModuleContent;
        loadModuleContent = function(module) {
            const result = originalLoadModuleContentUpdate(module);
            
            // 加载完内容后，根据模块类型加载数据
            setTimeout(() => {
                switch (module) {
                    case 'owner-info':
                        loadOwnerList();
                        break;
                    case 'property-management':
                        loadPropertyList();
                        break;
                    case 'parking-management':
                        loadParkingList();
                        break;
                    case 'charge-management':
                        loadChargeList();
                        break;
                    case 'announcements':
                        loadAnnouncementList();
                        break;
                    case 'complaints':
                        loadComplaintList();
                        break;
                    case 'profile':
                        loadStaffProfileData();
                        break;
                }
            }, 100);
            
            return result;
        };
    </script>
    
    <!-- Bootstrap JavaScript -->
    <script src="../js/bootstrap.min.js"></script>
</body>
</html>
